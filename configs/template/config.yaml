# Perf Analysis Service Configuration

# Analysis settings
analysis:
  version: "1.0.0"
  data_dir: "./data"
  max_worker: 5

# Database configuration
database:
  type: postgres  # postgres or mysql
  host: [[ .Service.postgres_apm.host ]]
  port: [[ .Service.postgres_apm.port ]]
  database: [[ index .Service.postgres_apm.databases 0 ]]
  user: [[ .Service.postgres_apm.user ]]
  password: [[ .Service.postgres_apm.pass ]]
  max_conns: 10

# Object storage configuration
storage:
  # type: local  # cos or local
  # # For local storage
  # local_path: ./storage
  
  # For COS storage (uncomment and fill in)
  type: cos
  bucket: [[ .Service.perf_bucket.bucket_name ]]-[[.Service.csp_secret.secret_appid]]
  region: {{ .Values.tad.location.regionName }}
  secret_id: [[.Service.csp_secret.secret_id]]
  secret_key: [[.Service.csp_secret.secret_key]]
  domain: [[ .Service.perf_bucket.host ]]
  scheme: [[ if .Service.perf_bucket.https ]]https[[ else ]]http[[ end ]]

# APM callback configuration
apm:
  enabled: false
  url: ""
  request_yunapi: true

# Scheduler configuration
scheduler:
  poll_interval: 2  # seconds
  worker_count: 5
  priority_slots: 2  # reserved slots for high-priority tasks
  task_batch_size: 10

# Task sources configuration (Strategy Pattern)
# Each source is a strategy that can be enabled/disabled independently
sources:
  # Database source - polls database for pending tasks
  - type: database
    name: primary-db
    enabled: true
    options:
      poll_interval: 2s    # how often to poll for new tasks
      batch_size: 10       # max tasks to fetch per poll

  # Kafka source - consumes tasks from Kafka topic (optional)
  # - type: kafka
  #   name: kafka-tasks
  #   enabled: false
  #   options:
  #     brokers:
  #       - localhost:9092
  #     topic: perf-tasks
  #     consumer_group: perf-analyzer
  #     auto_commit: false
  #     max_poll_records: 100

  # HTTP source - receives tasks via HTTP webhook (optional)
  # - type: http
  #   name: http-webhook
  #   enabled: false
  #   options:
  #     listen_addr: ":8081"
  #     path: /tasks
  #     read_timeout: 30s
  #     write_timeout: 30s
  #     max_body_size: 1048576  # 1MB

# Logging configuration
log:
  level: info  # debug, info, warn, error
  output_path: ./logs
  format: text  # text or json
