<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perf Analysis - Visualization</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                        accent: '#f093fb',
                        success: '#00c853',
                        warning: '#ff9800',
                        danger: '#f44336',
                    }
                }
            }
        }
    </script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- htmx -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- External Libraries -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.css">
    <!-- Application Styles -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/flamegraph.css">
    <link rel="stylesheet" href="/static/css/callgraph.css">
    <link rel="stylesheet" href="/static/css/heap.css">
</head>
<body class="bg-gray-100 text-gray-800" x-data="appState()" x-init="init()">
    <!-- Header -->
    <header class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-5 shadow-lg">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-semibold">ğŸ”¥ Perf Analysis Viewer</h1>
                <p class="text-sm opacity-90 mt-1">Interactive performance profiling visualization</p>
            </div>
            <div class="flex items-center gap-3">
                <label class="text-sm">Task:</label>
                <select x-model="currentTask" @change="loadTask($event.target.value)"
                    class="px-3 py-2 rounded-md border border-white/30 bg-white/10 text-white text-sm cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50">
                    <template x-if="tasks.length === 0">
                        <option value="" class="text-gray-800 bg-white" x-text="loading ? 'Loading...' : 'No tasks found'"></option>
                    </template>
                    <template x-for="(task, idx) in tasks" :key="task.id">
                        <option :value="task.id" class="text-gray-800 bg-white" x-text="task.id + (idx === 0 ? ' (latest)' : '')"></option>
                    </template>
                </select>
                <span x-show="loading" class="animate-spin text-lg">â³</span>
            </div>
        </div>
    </header>

    <!-- Container -->
    <main class="max-w-[1800px] mx-auto p-5">
        <!-- Tabs: Alpine.js ç®¡ç† -->
        <nav class="flex flex-wrap gap-2.5 mb-5">
            <!-- CPU Tabs -->
            <button @click="showPanel('overview')" 
                :class="{'tab-active': activePanel === 'overview'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ“Š Overview
            </button>
            <button @click="showPanel('flamegraph')" x-show="analysisType === 'cpu'"
                :class="{'tab-active': activePanel === 'flamegraph'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ”¥ Flame Graph
            </button>
            <button @click="showPanel('callgraph')" x-show="analysisType === 'cpu'"
                :class="{'tab-active': activePanel === 'callgraph'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ“ˆ Call Graph
            </button>
            <button @click="showPanel('topfuncs')" x-show="analysisType === 'cpu'"
                :class="{'tab-active': activePanel === 'topfuncs'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ“‹ Top Functions
            </button>
            <button @click="showPanel('threads')" x-show="analysisType === 'cpu'"
                :class="{'tab-active': activePanel === 'threads'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ§µ Threads
            </button>
            <!-- Heap Tabs -->
            <button @click="showPanel('heapdiagnosis')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heapdiagnosis'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ©º é—®é¢˜è¯Šæ–­
            </button>
            <button @click="showPanel('heaptreemap')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heaptreemap'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ—ºï¸ Biggest Objects
            </button>
            <button @click="showPanel('heapgcroots')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heapgcroots'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸŒ³ GC Roots
            </button>
            <button @click="showPanel('heapmergedpaths')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heapmergedpaths'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ”€ Merged Paths
            </button>
            <button @click="showPanel('heaphistogram')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heaphistogram'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ“Š Class Histogram
            </button>
            <button @click="showPanel('heaprootcause')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heaprootcause'}"
                class="tab-btn px-5 py-2.5 bg-white rounded-lg text-sm font-medium shadow-sm hover:bg-gray-100 transition-colors">
                ğŸ¯ è¯¦ç»†åˆ†æ
            </button>
        </nav>

        <!-- Overview Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'overview'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <!-- Task Metadata Card -->
            <div class="bg-white rounded-xl shadow-md p-5 mb-5 hidden" id="taskMetadataCard">
                <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">ğŸ“‹ Task Information</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                    <div class="flex flex-col gap-1 p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border-l-[3px] border-primary">
                        <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Task Type</span>
                        <span class="text-sm font-semibold text-gray-800 font-mono break-all" id="metaTaskType">-</span>
                    </div>
                    <div class="flex flex-col gap-1 p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border-l-[3px] border-primary">
                        <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Profiler</span>
                        <span class="text-sm font-semibold text-gray-800 font-mono break-all" id="metaProfiler">-</span>
                    </div>
                    <div class="flex flex-col gap-1 p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border-l-[3px] border-primary">
                        <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Input File</span>
                        <span class="text-sm font-semibold text-gray-800 font-mono break-all" id="metaInputFile">-</span>
                    </div>
                    <div class="flex flex-col gap-1 p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border-l-[3px] border-primary">
                        <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Created At</span>
                        <span class="text-sm font-semibold text-gray-800 font-mono break-all" id="metaCreatedAt">-</span>
                    </div>
                    <div class="flex flex-col gap-1 p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border-l-[3px] border-primary">
                        <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Analysis Time</span>
                        <span class="text-sm font-semibold text-gray-800 font-mono break-all" id="metaAnalysisTime">-</span>
                    </div>
                    <div class="flex flex-col gap-1 p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border-l-[3px] border-primary">
                        <span class="text-xs text-gray-500 font-medium uppercase tracking-wide">Task UUID</span>
                        <span class="text-sm font-semibold text-gray-800 font-mono break-all" id="metaTaskUUID">-</span>
                    </div>
                </div>
            </div>

            <!-- Stats Grid: Tailwind æ›¿æ¢ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-5">
                <div class="bg-gradient-to-br from-gray-50 to-gray-200 rounded-xl p-5 text-center">
                    <div class="text-3xl font-bold text-primary" id="totalSamples">-</div>
                    <div class="text-sm text-gray-500 mt-1">Total Samples</div>
                </div>
                <div class="bg-gradient-to-br from-gray-50 to-gray-200 rounded-xl p-5 text-center">
                    <div class="text-3xl font-bold text-primary" id="topFuncsCount">-</div>
                    <div class="text-sm text-gray-500 mt-1">Functions Analyzed</div>
                </div>
                <div class="bg-gradient-to-br from-gray-50 to-gray-200 rounded-xl p-5 text-center">
                    <div class="text-3xl font-bold text-primary" id="threadsCount">-</div>
                    <div class="text-sm text-gray-500 mt-1">Active Threads</div>
                </div>
                <div class="bg-gradient-to-br from-gray-50 to-gray-200 rounded-xl p-5 text-center">
                    <div class="text-3xl font-bold text-primary" id="taskUUID">-</div>
                    <div class="text-sm text-gray-500 mt-1">Task UUID</div>
                </div>
            </div>

            <!-- Top Functions Card -->
            <div class="bg-white rounded-xl shadow-md p-5">
                <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">Top 5 Hot Functions</h2>
                <p class="text-xs text-gray-400 mb-2.5">ğŸ’¡ Click action buttons to search in Flame Graph or Call Graph</p>
                <table class="top-funcs-table w-full" style="table-layout: auto;">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Function</th>
                            <th style="width: 180px;">Self %</th>
                            <th style="width: 100px; white-space: nowrap;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="topFuncsPreview"></tbody>
                </table>
            </div>
        </div>

        <!-- Flame Graph Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'flamegraph'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <p class="text-xs text-gray-400 mb-2.5 space-x-4">
                <span>ğŸ’¡ Click to zoom in, double-click to zoom out</span>
                <span>ğŸ” Use search to highlight functions</span>
            </p>
            <!-- Controls: Tailwind æ›¿æ¢ -->
            <div class="flex flex-wrap items-center gap-2.5 mb-4">
                <input type="text" id="searchInput" 
                    placeholder="Search function name (e.g. HashMap, alibaba, netty)..." 
                    onkeyup="handleSearchKeyup(event)"
                    class="flex-1 min-w-[200px] max-w-[400px] px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                <button onclick="searchFlameGraph()" class="px-5 py-2.5 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">ğŸ” Search</button>
                <button onclick="clearSearch()" class="px-5 py-2.5 bg-gray-500 text-white rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">Clear</button>
                <button onclick="resetFlameGraph()" class="px-5 py-2.5 bg-gray-500 text-white rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">Reset View</button>
                <span id="searchResultBadge" class="search-result-badge hidden"></span>
            </div>
            <!-- Filter Section: Tailwind æ›¿æ¢ -->
            <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg text-sm mb-4" id="flameFilterSection">
                <span class="text-gray-500 font-medium whitespace-nowrap">ğŸ”§ Filter:</span>
                <div class="flex flex-wrap gap-1.5">
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-white border border-gray-300 rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors" data-filter="jvm" onclick="toggleFlameFilter('jvm')" title="JDK/JVM internal functions">
                        <span class="text-[11px]">â˜•</span> JVM
                    </div>
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-white border border-gray-300 rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors" data-filter="gc" onclick="toggleFlameFilter('gc')" title="Garbage Collection functions">
                        <span class="text-[11px]">ğŸ—‘ï¸</span> GC
                    </div>
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-white border border-gray-300 rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors" data-filter="native" onclick="toggleFlameFilter('native')" title="Native/C++ runtime functions">
                        <span class="text-[11px]">âš™ï¸</span> Native
                    </div>
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-white border border-gray-300 rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors" data-filter="kernel" onclick="toggleFlameFilter('kernel')" title="Linux kernel functions">
                        <span class="text-[11px]">ğŸ§</span> Kernel
                    </div>
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-white border border-gray-300 rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors" data-filter="reflect" onclick="toggleFlameFilter('reflect')" title="Reflection and proxy functions">
                        <span class="text-[11px]">ğŸ”„</span> Reflect
                    </div>
                </div>
            </div>
            <div id="flame-details" class="flex flex-wrap gap-4 text-sm text-gray-600 mb-4">
                <div class="flex items-center gap-1.5">
                    <span class="font-medium">ğŸ“Š Total Samples:</span>
                    <span id="flame-total-samples">-</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="font-medium">ğŸ“ˆ Unique Functions:</span>
                    <span id="flame-unique-funcs">-</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="font-medium">ğŸ”¥ Max Depth:</span>
                    <span id="flame-max-depth">-</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="font-medium">ğŸ’¡ Tip:</span>
                    <span class="text-gray-400">Click frame to zoom, right-click to zoom out</span>
                </div>
            </div>
            <div id="flamegraph">
                <div class="loading text-center py-10 text-gray-500">Loading flame graph</div>
            </div>
        </div>

        <!-- Call Graph Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'callgraph'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <div class="tips">
                <span>ğŸ’¡ Drag nodes to reposition</span>
                <span>ğŸ” Scroll to zoom</span>
                <span>ğŸ–±ï¸ Hover on nodes for details</span>
                <span>âŒ¨ï¸ Arrow keys to navigate matches</span>
            </div>
            <div class="controls">
                <input type="text" id="callgraphSearchInput" placeholder="Search function name..." onkeyup="handleCallGraphSearchKeyup(event)">
                <button onclick="searchCallGraph()">ğŸ” Search</button>
                <button class="secondary" onclick="clearCallGraphSearch()">Clear</button>
                <div class="search-nav">
                    <button class="nav-btn" id="cgPrevBtn" onclick="navigateCallGraphMatch(-1)" disabled>â† Prev</button>
                    <span class="search-counter" id="cgSearchCounter"></span>
                    <button class="nav-btn" id="cgNextBtn" onclick="navigateCallGraphMatch(1)" disabled>Next â†’</button>
                </div>
                <div class="view-mode-switch">
                    <span class="switch-label left active">All</span>
                    <div class="switch-track" id="viewModeSwitch" onclick="toggleViewMode()" title="Toggle between All nodes and Focus mode">
                        <div class="switch-thumb"></div>
                    </div>
                    <span class="switch-label right">Focus</span>
                </div>
                <button class="secondary" onclick="fitCallGraph()">Fit to View</button>
                <button class="secondary" onclick="resetCallGraph()">Reset Layout</button>
            </div>
            <div class="filter-section" id="callgraphFilterSection">
                <span class="filter-label">ğŸ”§ Filter:</span>
                <div class="filter-chips">
                    <div class="filter-chip" data-filter="jvm" onclick="toggleCallGraphFilter('jvm')" title="JDK/JVM internal functions">
                        <span class="chip-icon">â˜•</span> JVM
                    </div>
                    <div class="filter-chip" data-filter="gc" onclick="toggleCallGraphFilter('gc')" title="Garbage Collection functions">
                        <span class="chip-icon">ğŸ—‘ï¸</span> GC
                    </div>
                    <div class="filter-chip" data-filter="native" onclick="toggleCallGraphFilter('native')" title="Native/C++ runtime functions">
                        <span class="chip-icon">âš™ï¸</span> Native
                    </div>
                    <div class="filter-chip" data-filter="kernel" onclick="toggleCallGraphFilter('kernel')" title="Linux kernel functions">
                        <span class="chip-icon">ğŸ§</span> Kernel
                    </div>
                    <div class="filter-chip" data-filter="reflect" onclick="toggleCallGraphFilter('reflect')" title="Reflection and proxy functions">
                        <span class="chip-icon">ğŸ”„</span> Reflect
                    </div>
                </div>
            </div>
            <div class="callgraph-stats" id="callgraphStats" style="display: none;">
                <div class="stat">
                    <span class="stat-label">ğŸ¯ Matches:</span>
                    <span class="stat-value" id="cgStatMatches">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">ğŸ“ Entry Points:</span>
                    <span class="stat-value" id="cgStatRoots">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">ğŸ”— Chain Depth:</span>
                    <span class="stat-value" id="cgStatDepth">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">ğŸ“Š Visible Nodes:</span>
                    <span class="stat-value" id="cgStatVisible">0</span>
                </div>
            </div>
            <div class="callgraph-container">
                <div id="callgraph">
                    <div class="loading">Loading call graph</div>
                </div>
                <div class="callchain-sidebar" id="callchainSidebar">
                    <div class="callchain-header">
                        <span>ğŸ“‹ Call Chain</span>
                        <button class="callchain-close" onclick="toggleCallChainSidebar(false)">Ã—</button>
                    </div>
                    <div class="callchain-content" id="callchainContent"></div>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #00c853;"></div>
                    <span>Entry Point (Root)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #7c4dff;"></div>
                    <span>Call Chain</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e040fb;"></div>
                    <span>Target (Match)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f8d568;"></div>
                    <span>Other Nodes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9c27b0; border: 1px dashed #9c27b0;"></div>
                    <span>Bridge Edge (filtered bypass)</span>
                </div>
            </div>
        </div>

        <!-- Top Functions Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'topfuncs'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">All Functions (sorted by self %)</h2>
            <p class="text-xs text-gray-400 mb-2.5">ğŸ’¡ Click action buttons to search in Flame Graph or Call Graph</p>
            <table class="top-funcs-table w-full" style="table-layout: auto;">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>Function</th>
                        <th style="width: 180px;">Self %</th>
                        <th style="width: 100px; white-space: nowrap;">Actions</th>
                    </tr>
                </thead>
                <tbody id="topFuncsAll"></tbody>
            </table>
        </div>

        <!-- Threads Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'threads'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">Thread Statistics</h2>
            <ul class="thread-list divide-y divide-gray-100" id="threadList"></ul>
        </div>

        <!-- Heap Diagnosis Overview Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'heapdiagnosis'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">ğŸ©º é—®é¢˜è¯Šæ–­æ¦‚è§ˆ</h2>
            <p class="text-xs text-gray-400 mb-4 space-x-4">
                <span>ğŸ’¡ å¿«é€Ÿå®šä½å†…å­˜é—®é¢˜ï¼Œç›´æ¥å‘Šè¯‰ä½ é—®é¢˜åœ¨å“ª</span>
                <span>ğŸ” ç‚¹å‡»é—®é¢˜å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…å’Œè§£å†³æ–¹æ¡ˆ</span>
            </p>
            <div id="diagnosisContainer">
                <div class="loading text-center py-10 text-gray-500">åˆ†æä¸­...</div>
            </div>
        </div>

        <!-- Heap Biggest Objects Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'heaptreemap'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">ğŸ—ºï¸ Biggest Objects</h2>
            <p class="text-xs text-gray-400 mb-4 space-x-4">
                <span>ğŸ’¡ Click on a block to zoom in, right-click to zoom out</span>
                <span>ğŸ“Š Block size represents memory usage</span>
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-5" id="heapStatsGrid">
                <div class="bg-gradient-to-br from-gray-50 to-gray-200 rounded-xl p-5 text-center">
                    <div class="text-2xl font-bold text-primary" id="heapTotalSize">-</div>
                    <div class="text-sm text-gray-500 mt-1">Total Heap Size</div>
                </div>
                <div class="bg-gradient-to-br from-gray-50 to-gray-200 rounded-xl p-5 text-center">
                    <div class="text-2xl font-bold text-primary" id="heapTotalClasses">-</div>
                    <div class="text-sm text-gray-500 mt-1">Total Classes</div>
                </div>
                <div class="bg-gradient-to-br from-gray-50 to-gray-200 rounded-xl p-5 text-center">
                    <div class="text-2xl font-bold text-primary" id="heapTotalInstances">-</div>
                    <div class="text-sm text-gray-500 mt-1">Total Instances</div>
                </div>
                <div class="bg-gradient-to-br from-gray-50 to-gray-200 rounded-xl p-5 text-center">
                    <div class="text-2xl font-bold text-primary" id="heapFormat">-</div>
                    <div class="text-sm text-gray-500 mt-1">Heap Format</div>
                </div>
            </div>
            <div id="heapTreemap"></div>
        </div>

        <!-- Heap GC Roots Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'heapgcroots'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">ğŸŒ³ GC Roots</h2>
            <p class="text-xs text-gray-400 mb-4 space-x-4">
                <span>ğŸ’¡ GC Roots are objects that are always reachable and prevent garbage collection</span>
                <span>ğŸ” Click to expand and see retained objects</span>
            </p>
            <div class="flex gap-6 mb-4" id="gcRootsSummary">
                <div class="flex flex-col items-center">
                    <span class="text-2xl font-bold text-primary" id="gcRootsTotalCount">-</span>
                    <span class="text-sm text-gray-500">Total GC Roots</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-2xl font-bold text-primary" id="gcRootsRetainedSize">-</span>
                    <span class="text-sm text-gray-500">Total Retained Size</span>
                </div>
            </div>
            <div class="flex gap-2.5 mb-4">
                <input type="text" id="gcRootsSearch" placeholder="Filter GC Roots..." onkeyup="HeapAnalysis.filterGCRoots()"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                <select id="gcRootsTypeFilter" onchange="HeapAnalysis.filterGCRoots()"
                    class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <option value="">All Types</option>
                    <option value="Thread">Thread</option>
                    <option value="Class">Class</option>
                    <option value="JNI">JNI</option>
                    <option value="Monitor">Monitor</option>
                    <option value="Sticky">Sticky Class</option>
                </select>
            </div>
            <div class="gc-roots-table-container overflow-x-auto">
                <table class="gc-roots-table w-full" id="gcRootsTable">
                    <thead>
                        <tr>
                            <th class="w-[30px]"></th>
                            <th>Item</th>
                            <th class="w-[140px]">Shallow</th>
                            <th class="w-[140px]">Retained</th>
                        </tr>
                    </thead>
                    <tbody id="gcRootsTableBody">
                        <tr><td colspan="4" class="loading text-center py-10 text-gray-500">Loading GC Roots...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Heap Merged Paths Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'heapmergedpaths'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">ğŸ”€ Merged Paths (Retainers)</h2>
            <p class="text-xs text-gray-400 mb-4 space-x-4">
                <span>ğŸ’¡ å±•ç¤ºå†…å­˜å ç”¨å¤§ç±»è¢«å“ªäº›ç±»æŒæœ‰ï¼ˆRetained byï¼‰</span>
                <span>ğŸ” ç‚¹å‡»ç±»åå±•å¼€æŸ¥çœ‹è¯¦ç»†çš„æŒæœ‰è€…åˆ—è¡¨</span>
                <span>ğŸ“Š æŒ‰ä¿ç•™å†…å­˜å¤§å°æ’åº</span>
            </p>
            <div class="merged-paths-container" id="mergedPathsContainer">
                <div class="loading text-center py-10 text-gray-500">åŠ è½½ Retainer æ•°æ®ä¸­...</div>
            </div>
        </div>

        <!-- Heap Histogram Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'heaphistogram'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">ğŸ“Š Class Histogram</h2>
            <div class="flex flex-wrap items-center gap-2.5 mb-4">
                <input type="text" id="heapClassSearch" placeholder="Search class name (e.g. HashMap, byte[], String)..." onkeyup="filterHeapClasses()"
                    class="flex-1 min-w-[200px] max-w-[400px] px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                <button onclick="filterHeapClasses()" class="px-5 py-2.5 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">ğŸ” Search</button>
                <button onclick="clearHeapSearch()" class="px-5 py-2.5 bg-gray-500 text-white rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">Clear</button>
            </div>
            <div class="flex gap-2 mb-4">
                <button class="heap-view-btn active px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium" id="heapViewFlat" onclick="setHeapView('flat')">ğŸ“‹ Flat View</button>
                <button class="heap-view-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300" id="heapViewPackage" onclick="setHeapView('package')">ğŸ“¦ Package View</button>
            </div>
            <div id="heapHistogramContainer">
                <div id="heapFlatView">
                    <table class="heap-class-table idea-style w-full">
                        <thead>
                            <tr>
                                <th class="w-[30px]"></th>
                                <th class="sortable" data-sort="name" onclick="HeapAnalysis.sortHistogram('name')">Class</th>
                                <th class="sortable w-[120px]" data-sort="count" onclick="HeapAnalysis.sortHistogram('count')">Count</th>
                                <th class="sortable active w-[160px]" data-sort="shallow" onclick="HeapAnalysis.sortHistogram('shallow')">Shallow â–¼</th>
                                <th class="sortable w-[160px]" data-sort="retained" onclick="HeapAnalysis.sortHistogram('retained')">Retained</th>
                            </tr>
                        </thead>
                        <tbody id="heapClassTableBody"></tbody>
                    </table>
                </div>
                <div id="heapPackageView" class="hidden">
                    <div id="heapPackageGroups"></div>
                </div>
            </div>
        </div>

        <!-- Heap Root Cause Analysis Panel: Alpine.js æ§åˆ¶æ˜¾ç¤º -->
        <div x-show="activePanel === 'heaprootcause'" x-cloak class="bg-white rounded-xl shadow-md p-5">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-gray-800">ğŸ¯ Root Cause Analysis</h2>
            <p class="text-xs text-gray-400 mb-4 space-x-4">
                <span>ğŸ’¡ å¿«é€Ÿå®šä½å†…å­˜é—®é¢˜æ ¹å› </span>
                <span>ğŸ” æŒ‰ç…§è¯Šæ–­æ­¥éª¤é€ä¸€æ’æŸ¥</span>
            </p>
            
            <!-- Quick Diagnosis Section -->
            <section class="mb-6">
                <h3 class="text-base font-semibold text-gray-700 mb-3">ğŸš€ å¿«é€Ÿè¯Šæ–­æ­¥éª¤</h3>
                <div id="quickDiagnosisContainer">
                    <div class="loading text-center py-6 text-gray-500">åˆ†æä¸­...</div>
                </div>
            </section>

            <!-- Leak Suspects Section -->
            <section class="mb-6">
                <h3 class="text-base font-semibold text-gray-700 mb-3">âš ï¸ å†…å­˜æ³„æ¼å«Œç–‘</h3>
                <div id="leakSuspectsContainer">
                    <div class="loading text-center py-6 text-gray-500">åˆ†æä¸­...</div>
                </div>
            </section>

            <!-- Business Classes Section -->
            <section class="mb-6">
                <h3 class="text-base font-semibold text-gray-700 mb-3">ğŸ“¦ Top ä¸šåŠ¡ç±» (é JDK/æ¡†æ¶)</h3>
                <div id="businessClassesContainer">
                    <div class="loading text-center py-6 text-gray-500">åˆ†æä¸­...</div>
                </div>
            </section>

            <!-- Collection Issues Section -->
            <section class="mb-6">
                <h3 class="text-base font-semibold text-gray-700 mb-3">ğŸ“‹ é›†åˆç±»é—®é¢˜</h3>
                <div id="collectionIssuesContainer">
                    <div class="loading text-center py-6 text-gray-500">åˆ†æä¸­...</div>
                </div>
            </section>

            <!-- Business Retainers Summary -->
            <section class="mb-6">
                <h3 class="text-base font-semibold text-gray-700 mb-3">ğŸ“Š è¯¦ç»† Retainer åˆ†æ</h3>
                <div class="flex gap-2.5 mb-4">
                    <input type="text" id="rootCauseSearch" placeholder="æœç´¢ç±»å..." onkeyup="HeapAnalysis.filterRootCause()"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <button onclick="HeapAnalysis.filterRootCause()" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">ğŸ” æœç´¢</button>
                </div>
                <div id="businessRetainersContainer">
                    <div class="loading text-center py-6 text-gray-500">åŠ è½½ Retainer æ•°æ®ä¸­...</div>
                </div>
            </section>

            <!-- Suggestions Section -->
            <section>
                <h3 class="text-base font-semibold text-gray-700 mb-3">ğŸ’¡ ä¼˜åŒ–å»ºè®®</h3>
                <div id="heapSuggestionsContainer">
                    <div class="loading text-center py-6 text-gray-500">åŠ è½½å»ºè®®ä¸­...</div>
                </div>
            </section>
        </div>

    </main>

    <!-- Node Tooltip -->
    <div id="nodeTooltip" class="node-tooltip fixed bg-black/85 text-white px-4 py-2.5 rounded-lg text-sm max-w-[400px] break-all pointer-events-none z-[1000] hidden"></div>

    <!-- Alpine.js x-cloak style -->
    <style>
        [x-cloak] { display: none !important; }
        .tab-btn.tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
    </style>

    <!-- Alpine.js App State -->
    <script>
        function appState() {
            return {
                // State
                tasks: [],
                currentTask: '',
                loading: false,
                activePanel: 'overview',
                analysisType: 'cpu', // 'cpu' or 'heap'
                summaryData: null,

                // Initialize
                async init() {
                    // Initialize modules
                    FlameGraph.init();
                    CallGraph.init();
                    HeapAnalysis.init();

                    // Load tasks
                    await this.loadTasks();
                },

                // Load task list
                async loadTasks() {
                    this.loading = true;
                    try {
                        this.tasks = await API.getTasks() || [];
                        if (this.tasks.length > 0) {
                            this.currentTask = this.tasks[0].id;
                            await this.loadTask(this.currentTask);
                        }
                    } catch (err) {
                        console.error('Failed to load tasks:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                // Load specific task
                async loadTask(taskId) {
                    this.currentTask = taskId;
                    this.loading = true;
                    try {
                        await this.loadSummary(taskId);
                        if (this.analysisType === 'heap') {
                            HeapAnalysis.renderAnalysis(this.summaryData);
                        } else {
                            await Promise.all([
                                FlameGraph.load(taskId),
                                CallGraph.load(taskId)
                            ]);
                        }
                    } finally {
                        this.loading = false;
                    }
                },

                // Load summary data
                async loadSummary(taskId) {
                    try {
                        this.summaryData = await API.getSummary(taskId);
                        this.detectAnalysisType();
                        this.renderSummary();
                    } catch (err) {
                        console.error('Failed to load summary:', err);
                    }
                },

                // Detect analysis type from data
                detectAnalysisType() {
                    const data = this.summaryData;
                    if (!data) return;
                    
                    const taskType = data.task_type || '';
                    const metadata = data.metadata || {};
                    const taskTypeName = metadata.task_type_name || taskType;

                    if (taskTypeName === 'java_heap' || taskType === 'java_heap' ||
                        (data.data && data.data.total_heap_size !== undefined)) {
                        this.analysisType = 'heap';
                    } else {
                        this.analysisType = 'cpu';
                    }
                },

                // Render summary data
                renderSummary() {
                    const data = this.summaryData;
                    if (!data) return;

                    if (this.analysisType === 'heap') {
                        HeapAnalysis.renderOverview(data);
                        this.renderTaskMetadata(data.metadata);
                        return;
                    }

                    // Stats for CPU/Allocation analysis
                    document.getElementById('totalSamples').textContent = data.total_records || 0;
                    document.getElementById('topFuncsCount').textContent = (data.top_items || []).length || Object.keys(data.top_funcs || {}).length;
                    document.getElementById('threadsCount').textContent = (data.threads || []).length;
                    document.getElementById('taskUUID').textContent = data.task_uuid || '-';

                    this.renderTaskMetadata(data.metadata);
                    this.renderTopFunctions(data);
                    this.renderThreads(data);
                },

                // Render task metadata
                renderTaskMetadata(metadata) {
                    const card = document.getElementById('taskMetadataCard');
                    if (!metadata) {
                        card.style.display = 'none';
                        return;
                    }

                    card.style.display = 'block';

                    const typeName = metadata.task_type_name || 'unknown';
                    const typeClass = this.getTaskTypeClass(typeName);
                    const typeIcon = this.getTaskTypeIcon(typeName);
                    document.getElementById('metaTaskType').innerHTML = `<span class="type-badge ${typeClass}">${typeIcon} ${typeName.toUpperCase()}</span>`;

                    const profilerName = metadata.profiler_name || 'unknown';
                    const profilerIcon = this.getProfilerIcon(profilerName);
                    document.getElementById('metaProfiler').innerHTML = `<span class="profiler-badge">${profilerIcon} ${profilerName}</span>`;

                    document.getElementById('metaInputFile').textContent = metadata.input_file || '-';
                    document.getElementById('metaCreatedAt').textContent = metadata.created_at ? Utils.formatDateTime(metadata.created_at) : '-';
                    document.getElementById('metaAnalysisTime').textContent = metadata.analysis_time_ms ? Utils.formatDuration(metadata.analysis_time_ms) : '-';
                    document.getElementById('metaTaskUUID').textContent = this.summaryData?.task_uuid || '-';
                },

                // Render top functions
                renderTopFunctions(data) {
                    let funcs = [];
                    if (data.top_items && data.top_items.length > 0) {
                        funcs = data.top_items.map(item => ({ name: item.name, self: item.percentage || 0 }));
                    } else if (data.top_funcs) {
                        funcs = Object.entries(data.top_funcs)
                            .map(([name, val]) => ({ name, self: val.self || 0 }))
                            .sort((a, b) => b.self - a.self);
                    }

                    const self = this;
                    const renderRow = (f, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td class="func-name func-name-clickable" title="Click to copy function name" onclick="Utils.copyToClipboard('${Utils.escapeHtml(f.name).replace(/'/g, "\\'")}')">${Utils.escapeHtml(f.name)}</td>
                            <td>
                                <div class="percentage-bar">
                                    <div class="percentage-bar-fill" style="width: ${Math.min(f.self, 100)}%"></div>
                                </div>
                                ${f.self.toFixed(2)}%
                            </td>
                            <td>
                                <button class="action-btn flame" title="Search in Flame Graph" onclick="App.searchInFlameGraph('${Utils.escapeHtml(f.name).replace(/'/g, "\\'")}')">ğŸ”¥</button>
                                <button class="action-btn callgraph" title="Search in Call Graph" onclick="App.searchInCallGraph('${Utils.escapeHtml(f.name).replace(/'/g, "\\'")}')">ğŸ“ˆ</button>
                            </td>
                        </tr>
                    `;

                    document.getElementById('topFuncsPreview').innerHTML = funcs.slice(0, 5).map(renderRow).join('');
                    document.getElementById('topFuncsAll').innerHTML = funcs.map(renderRow).join('');
                },

                // Render threads
                renderThreads(data) {
                    const threadList = document.getElementById('threadList');
                    threadList.innerHTML = (data.threads || []).map(t => `
                        <li class="thread-item">
                            <span class="thread-name">${Utils.escapeHtml(t.thread_name || 'Unknown')}</span>
                            <span class="thread-samples">${t.samples} samples (${(t.percentage || 0).toFixed(2)}%)</span>
                        </li>
                    `).join('');
                },

                // Show panel
                showPanel(panelId) {
                    this.activePanel = panelId;

                    // Trigger panel-specific actions after DOM update
                    if (panelId === 'flamegraph' && FlameGraph.getData()) {
                        // ç­‰å¾… Alpine.js æ›´æ–° DOM åå†æ¸²æŸ“ç«ç„°å›¾
                        this.$nextTick(() => {
                            requestAnimationFrame(() => FlameGraph.render());
                        });
                    } else if (panelId === 'heapdiagnosis' && this.summaryData) {
                        HeapAnalysis.renderDiagnosis(this.summaryData);
                    } else if (panelId === 'heaptreemap') {
                        // ç­‰å¾… Alpine.js æ›´æ–° DOM åå†æ¸²æŸ“ treemap
                        this.$nextTick(() => {
                            requestAnimationFrame(() => HeapAnalysis.resizeTreemap());
                        });
                    } else if (panelId === 'heaprootcause' && this.summaryData) {
                        HeapAnalysis.renderRootCauseAnalysis(this.summaryData);
                    }
                },

                // Search in flame graph
                searchInFlameGraph(funcName) {
                    this.showPanel('flamegraph');
                    setTimeout(() => FlameGraph.searchFor(funcName), 100);
                },

                // Search in call graph
                searchInCallGraph(funcName) {
                    this.showPanel('callgraph');
                    setTimeout(() => CallGraph.searchFor(funcName), 100);
                },

                // Helper methods
                getTaskTypeClass(typeName) {
                    const typeMap = {
                        'java': 'java', 'generic': 'generic', 'pprof_mem': 'pprof',
                        'memleak': 'memory', 'java_heap': 'heap', 'phys_mem': 'memory',
                        'jeprof': 'memory', 'tracing': 'tracing', 'timing': 'tracing'
                    };
                    return typeMap[typeName] || 'generic';
                },

                getTaskTypeIcon(typeName) {
                    const iconMap = {
                        'java': 'â˜•', 'generic': 'ğŸ”§', 'pprof_mem': 'ğŸ¹', 'memleak': 'ğŸ’¾',
                        'java_heap': 'ğŸ“¦', 'phys_mem': 'ğŸ§ ', 'jeprof': 'ğŸ“Š', 'tracing': 'ğŸ”',
                        'timing': 'â±ï¸', 'bolt': 'âš¡'
                    };
                    return iconMap[typeName] || 'ğŸ“Š';
                },

                getProfilerIcon(profilerName) {
                    const iconMap = { 'perf': 'ğŸ”¥', 'async_alloc': 'ğŸ“ˆ', 'pprof': 'ğŸ¹' };
                    return iconMap[profilerName] || 'ğŸ“Š';
                }
            };
        }

        // Register Alpine store for global access
        document.addEventListener('alpine:init', () => {
            Alpine.store('app', {
                getAppData() {
                    const appEl = document.querySelector('[x-data]');
                    return appEl && appEl._x_dataStack ? appEl._x_dataStack[0] : null;
                },
                searchInFlameGraph(funcName) {
                    const appData = this.getAppData();
                    if (appData) {
                        appData.searchInFlameGraph(funcName);
                    }
                },
                searchInCallGraph(funcName) {
                    const appData = this.getAppData();
                    if (appData) {
                        appData.searchInCallGraph(funcName);
                    }
                }
            });
        });
    </script>

    <!-- Application Scripts -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/flamegraph.js"></script>
    <script src="/static/js/callgraph.js"></script>
    <!-- Heap Analysis Modular Scripts (load order matters) -->
    <script src="/static/js/heap-core.js"></script>
    <script src="/static/js/heap-diagnosis.js"></script>
    <script src="/static/js/heap-treemap.js"></script>
    <script src="/static/js/heap-histogram.js"></script>
    <script src="/static/js/heap-gcroots.js"></script>
    <script src="/static/js/heap-merged-paths.js"></script>
    <script src="/static/js/heap-rootcause.js"></script>
    <script src="/static/js/heap.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
