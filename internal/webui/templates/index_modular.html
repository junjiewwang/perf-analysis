<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perf Analysis - Visualization</title>
    <!-- Theme CSS (load first for CSS variables) -->
    <link rel="stylesheet" href="/static/css/theme.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Use CSS variables for theme support
                        primary: 'rgb(var(--color-primary) / <alpha-value>)',
                        'primary-hover': 'rgb(var(--color-primary-hover) / <alpha-value>)',
                        secondary: 'rgb(var(--color-secondary) / <alpha-value>)',
                        accent: 'rgb(var(--color-accent) / <alpha-value>)',
                        success: 'rgb(var(--color-success) / <alpha-value>)',
                        warning: 'rgb(var(--color-warning) / <alpha-value>)',
                        danger: 'rgb(var(--color-danger) / <alpha-value>)',
                        info: 'rgb(var(--color-info) / <alpha-value>)',
                    },
                    backgroundColor: {
                        base: 'rgb(var(--color-bg-base) / <alpha-value>)',
                        card: 'rgb(var(--color-bg-card) / <alpha-value>)',
                        elevated: 'rgb(var(--color-bg-elevated) / <alpha-value>)',
                        muted: 'rgb(var(--color-bg-muted) / <alpha-value>)',
                    },
                    textColor: {
                        base: 'rgb(var(--color-text-base) / <alpha-value>)',
                        secondary: 'rgb(var(--color-text-secondary) / <alpha-value>)',
                        muted: 'rgb(var(--color-text-muted) / <alpha-value>)',
                        inverted: 'rgb(var(--color-text-inverted) / <alpha-value>)',
                    },
                    borderColor: {
                        theme: 'rgb(var(--color-border) / <alpha-value>)',
                        'theme-light': 'rgb(var(--color-border-light) / <alpha-value>)',
                    },
                }
            }
        }
    </script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- htmx -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- External Libraries -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.css">
    <!-- Tippy.js for tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light-border.css">
    <!-- Application Styles -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/flamegraph.css">
    <link rel="stylesheet" href="/static/css/callgraph.css">
    <link rel="stylesheet" href="/static/css/heap.css">
    <link rel="stylesheet" href="/static/css/threads.css">
    <!-- Theme Manager (load early) -->
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-base text-base" x-data="appState()" x-init="init()">
    <!-- Header -->
    <header class="bg-gradient-theme text-inverted px-8 py-5 shadow-lg">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-semibold">üî• Perf Analysis Viewer</h1>
                <p class="text-sm opacity-90 mt-1">Interactive performance profiling visualization</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- Task Selector -->
                <div class="flex items-center gap-3">
                    <label class="text-sm">Task:</label>
                    <select x-model="currentTask" @change="loadTask($event.target.value)"
                        class="px-3 py-2 rounded-md border border-white/30 bg-white/10 text-white text-sm cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50">
                        <template x-if="tasks.length === 0">
                            <option value="" class="text-gray-800 bg-white" x-text="loading ? 'Loading...' : 'No tasks found'"></option>
                        </template>
                        <template x-for="(task, idx) in tasks" :key="task.id">
                            <option :value="task.id" class="text-gray-800 bg-white" x-text="task.id + (idx === 0 ? ' (latest)' : '')"></option>
                        </template>
                    </select>
                    <span x-show="loading" class="animate-spin text-lg">‚è≥</span>
                </div>
                <!-- Theme Picker -->
                <div class="theme-picker relative">
                    <button class="theme-picker-trigger p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors flex items-center gap-2" 
                            onclick="ThemeManager.togglePicker()" 
                            title="Change theme">
                        <span id="themeIcon" class="text-lg">‚òÄÔ∏è</span>
                        <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="theme-picker-dropdown absolute right-0 top-full mt-2 bg-card rounded-lg shadow-lg border border-theme overflow-hidden z-50 min-w-[160px] hidden" id="themePickerDropdown">
                        <div class="p-2 border-b border-theme-light">
                            <span class="text-xs text-muted font-medium uppercase tracking-wider">Theme</span>
                        </div>
                        <div class="p-1">
                            <button class="theme-option w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-muted transition-colors text-left text-base" 
                                    data-theme-option="light" onclick="ThemeManager.setTheme('light')">
                                <span class="text-lg">‚òÄÔ∏è</span>
                                <span class="text-sm">Light</span>
                            </button>
                            <button class="theme-option w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-muted transition-colors text-left text-base" 
                                    data-theme-option="dark" onclick="ThemeManager.setTheme('dark')">
                                <span class="text-lg">üåô</span>
                                <span class="text-sm">Dark</span>
                            </button>
                            <button class="theme-option w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-muted transition-colors text-left text-base" 
                                    data-theme-option="purple" onclick="ThemeManager.setTheme('purple')">
                                <span class="text-lg">üíú</span>
                                <span class="text-sm">Purple</span>
                            </button>
                            <button class="theme-option w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-muted transition-colors text-left text-base" 
                                    data-theme-option="ocean" onclick="ThemeManager.setTheme('ocean')">
                                <span class="text-lg">üåä</span>
                                <span class="text-sm">Ocean</span>
                            </button>
                            <button class="theme-option w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-muted transition-colors text-left text-base" 
                                    data-theme-option="sunset" onclick="ThemeManager.setTheme('sunset')">
                                <span class="text-lg">üåÖ</span>
                                <span class="text-sm">Sunset</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Container -->
    <main class="max-w-[1800px] mx-auto p-5">
        <!-- Tabs: Alpine.js ÁÆ°ÁêÜ -->
        <nav class="flex flex-wrap gap-2.5 mb-5">
            <!-- CPU Tabs -->
            <button @click="showPanel('overview')" 
                :class="{'tab-active': activePanel === 'overview'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üìä Overview
            </button>
            <!-- Heap: Class Histogram (moved to second position) -->
            <button @click="showPanel('heaphistogram')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heaphistogram'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üìä Class Histogram
            </button>
            <button @click="showPanel('flamegraph')" x-show="analysisType === 'cpu' || analysisType === 'alloc' || analysisType === 'pprof-all'"
                :class="{'tab-active': activePanel === 'flamegraph'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üî• Flame Graph
            </button>
            <button @click="showPanel('callgraph')" x-show="analysisType === 'cpu' || analysisType === 'alloc' || (analysisType === 'pprof-all' && pprofSubType === 'cpu')"
                :class="{'tab-active': activePanel === 'callgraph'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üìà Call Graph
            </button>
            <button @click="showPanel('topfuncs')" x-show="analysisType === 'cpu' || analysisType === 'alloc' || analysisType === 'pprof-all'"
                :class="{'tab-active': activePanel === 'topfuncs'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üìã Top Functions
            </button>
            <button @click="showPanel('threads')" x-show="analysisType === 'cpu' || analysisType === 'alloc'"
                :class="{'tab-active': activePanel === 'threads'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üßµ Threads
            </button>
            <!-- pprof-all: Leak Detection Tab -->
            <button @click="showPanel('leakreport')" x-show="analysisType === 'pprof-all'"
                :class="{'tab-active': activePanel === 'leakreport'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üîç Leak Detection
            </button>
            <!-- Heap Tabs -->
            <button @click="showPanel('heaptreemap')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heaptreemap'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üó∫Ô∏è Biggest Objects
            </button>
            <button @click="showPanel('heapgcroots')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heapgcroots'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üå≥ GC Roots
            </button>
            <button @click="showPanel('heapmergedpaths')" x-show="analysisType === 'heap'"
                :class="{'tab-active': activePanel === 'heapmergedpaths'}"
                class="tab-btn px-5 py-2.5 bg-card rounded-lg text-sm font-medium shadow-sm hover:bg-muted transition-colors border border-theme text-base">
                üîÄ Merged Paths
            </button>
        </nav>

        <!-- Overview Panel: Alpine.js ÊéßÂà∂ÊòæÁ§∫ -->
        <div x-show="activePanel === 'overview'" x-cloak class="space-y-5">
            <!-- Task Metadata Card -->
            <div class="bg-card rounded-xl shadow-sm border border-theme p-6 hidden" id="taskMetadataCard">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white text-lg">üìã</div>
                    <h2 class="text-lg font-semibold text-base">Task Information</h2>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="group p-4 bg-muted hover:bg-gradient-to-br hover:from-primary/5 hover:to-secondary/5 rounded-xl border border-theme hover:border-primary/20 transition-all duration-200">
                        <span class="text-[10px] text-muted font-semibold uppercase tracking-wider">Analysis Mode</span>
                        <div class="mt-2" id="metaTaskType">-</div>
                    </div>
                    <div class="group p-4 bg-muted hover:bg-gradient-to-br hover:from-primary/5 hover:to-secondary/5 rounded-xl border border-theme hover:border-primary/20 transition-all duration-200">
                        <span class="text-[10px] text-muted font-semibold uppercase tracking-wider">Profile</span>
                        <div class="mt-2 text-sm font-medium text-secondary" id="metaProfiler">-</div>
                    </div>
                    <div class="group p-4 bg-muted hover:bg-gradient-to-br hover:from-primary/5 hover:to-secondary/5 rounded-xl border border-theme hover:border-primary/20 transition-all duration-200">
                        <span class="text-[10px] text-muted font-semibold uppercase tracking-wider">Input File</span>
                        <div class="mt-2 text-sm font-medium text-secondary font-mono truncate" id="metaInputFile" title="">-</div>
                    </div>
                    <div class="group p-4 bg-muted hover:bg-gradient-to-br hover:from-primary/5 hover:to-secondary/5 rounded-xl border border-theme hover:border-primary/20 transition-all duration-200">
                        <span class="text-[10px] text-muted font-semibold uppercase tracking-wider">Created At</span>
                        <div class="mt-2 text-sm font-medium text-secondary" id="metaCreatedAt">-</div>
                    </div>
                    <div class="group p-4 bg-muted hover:bg-gradient-to-br hover:from-primary/5 hover:to-secondary/5 rounded-xl border border-theme hover:border-primary/20 transition-all duration-200">
                        <span class="text-[10px] text-muted font-semibold uppercase tracking-wider">Analysis Time</span>
                        <div class="mt-2 text-sm font-medium text-secondary" id="metaAnalysisTime">-</div>
                    </div>
                    <div class="group p-4 bg-muted hover:bg-gradient-to-br hover:from-primary/5 hover:to-secondary/5 rounded-xl border border-theme hover:border-primary/20 transition-all duration-200">
                        <span class="text-[10px] text-muted font-semibold uppercase tracking-wider">Task UUID</span>
                        <div class="mt-2 text-sm font-medium text-secondary font-mono" id="metaTaskUUID">-</div>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="relative overflow-hidden bg-card rounded-xl shadow-sm border border-theme p-5 group hover:shadow-md transition-shadow">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-primary/10 to-secondary/10 rounded-bl-[80px] -mr-2 -mt-2"></div>
                    <div class="relative">
                        <div class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent" id="totalSamples">-</div>
                        <div class="text-sm text-muted mt-1 stat-label">Total Samples</div>
                    </div>
                </div>
                <div class="relative overflow-hidden bg-card rounded-xl shadow-sm border border-theme p-5 group hover:shadow-md transition-shadow">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-green-500/10 to-teal-500/10 rounded-bl-[80px] -mr-2 -mt-2"></div>
                    <div class="relative">
                        <div class="text-3xl font-bold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent" id="topFuncsCount">-</div>
                        <div class="text-sm text-muted mt-1 stat-label">Functions Analyzed</div>
                    </div>
                </div>
                <div class="relative overflow-hidden bg-card rounded-xl shadow-sm border border-theme p-5 group hover:shadow-md transition-shadow">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-orange-500/10 to-amber-500/10 rounded-bl-[80px] -mr-2 -mt-2"></div>
                    <div class="relative">
                        <div class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent" id="threadsCount">-</div>
                        <div class="text-sm text-muted mt-1 stat-label">Active Threads</div>
                    </div>
                </div>
                <div class="relative overflow-hidden bg-card rounded-xl shadow-sm border border-theme p-5 group hover:shadow-md transition-shadow">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-pink-500/10 to-rose-500/10 rounded-bl-[80px] -mr-2 -mt-2"></div>
                    <div class="relative">
                        <div class="text-xl font-bold bg-gradient-to-r from-pink-600 to-rose-600 bg-clip-text text-transparent font-mono truncate" id="taskUUID">-</div>
                        <div class="text-sm text-muted mt-1">Task UUID</div>
                    </div>
                </div>
            </div>

            <!-- pprof-all: Profile Type Cards (only shown in pprof-all mode) -->
            <div id="pprofProfileCards" x-show="analysisType === 'pprof-all'" x-cloak class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>

            <!-- pprof-all: Leak Reports Summary (only shown in pprof-all mode) -->
            <div id="pprofLeakReports" x-show="analysisType === 'pprof-all'" x-cloak class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="text-muted text-sm">Loading leak reports...</div>
            </div>

            <!-- Top Functions Card -->
            <div class="bg-card rounded-xl shadow-sm border border-theme overflow-hidden">
                <div class="px-6 py-4 border-b border-theme flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white">üî•</div>
                        <div>
                            <h2 class="text-base font-semibold text-base">Top 5 Hot Functions</h2>
                            <p class="text-xs text-muted mt-0.5">üí° Click action buttons to search in Flame Graph or Call Graph</p>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-muted text-left">
                                <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-12">#</th>
                                <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Function</th>
                                <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-48">Self %</th>
                                <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-28 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="topFuncsPreview" class="divide-y divide-theme"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Leak Report Panel (pprof-all only) -->
        <div x-show="activePanel === 'leakreport'" x-cloak class="space-y-5">
            <div class="bg-card rounded-xl shadow-sm border border-theme p-6">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-red-500 to-orange-500 flex items-center justify-center text-white text-lg">üîç</div>
                    <div>
                        <h2 class="text-lg font-semibold text-base">Leak Detection Report</h2>
                        <p class="text-sm text-muted">Memory and goroutine leak analysis based on profile comparison</p>
                    </div>
                </div>
                <div id="leakReportDetail" class="space-y-6">
                    <div class="text-muted text-center py-8">Loading leak detection data...</div>
                </div>
            </div>
        </div>

        <!-- Flame Graph Panel: Alpine.js ÊéßÂà∂ÊòæÁ§∫ -->
        <div x-show="activePanel === 'flamegraph'" x-cloak class="bg-card rounded-xl shadow-md p-5 border border-theme">
            <p class="text-xs text-muted mb-2.5 space-x-4">
                <span>üí° Click to zoom in, double-click to zoom out</span>
                <span>üîç Use search to highlight functions</span>
            </p>
            <!-- Thread Selector for Flame Graph -->
            <div class="thread-selector-container" id="flameThreadSelectorContainer" style="display: none;">
                <span class="thread-selector-label"><span class="icon">üßµ</span>Thread View:</span>
                <div class="thread-selector-wrapper" id="flameThreadSelectorWrapper">
                    <div class="thread-selector-trigger" onclick="toggleFlameThreadDropdown()">
                        <span class="thread-selected-text" id="flameThreadSelectedText">
                            <span class="global-icon">üåê</span> Global View (All Threads)
                        </span>
                        <span class="thread-selector-arrow">‚ñº</span>
                    </div>
                    <div class="thread-dropdown-container">
                        <div class="thread-search-box">
                            <input type="text" 
                                   class="thread-search-input" 
                                   id="flameThreadSearchInput" 
                                   placeholder="Search threads by name, group, or TID..."
                                   oninput="handleFlameThreadSearch(this.value)"
                                   onkeydown="handleFlameThreadSearchKeydown(event)">
                        </div>
                        <div class="thread-dropdown" id="flameThreadDropdown">
                            <!-- Dropdown items will be populated dynamically -->
                        </div>
                    </div>
                </div>
                <span class="thread-info-badge">
                    <span>Threads</span>
                    <span class="count" id="flameThreadCount">0</span>
                </span>
            </div>
            <!-- Controls: Tailwind ÊõøÊç¢ -->
            <div class="flex flex-wrap items-center gap-2.5 mb-4">
                <input type="text" id="searchInput" 
                    placeholder="Search function name (e.g. HashMap, alibaba, netty)..." 
                    onkeyup="handleSearchKeyup(event)"
                    class="flex-1 min-w-[200px] max-w-[400px] px-4 py-2.5 border border-theme rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary bg-card text-base">
                <button onclick="searchFlameGraph()" class="px-5 py-2.5 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">üîç Search</button>
                <button onclick="clearSearch()" class="px-5 py-2.5 bg-elevated text-base rounded-lg text-sm font-medium hover:bg-muted transition-colors border border-theme">Clear</button>
                <button onclick="resetFlameGraph()" class="px-5 py-2.5 bg-elevated text-base rounded-lg text-sm font-medium hover:bg-muted transition-colors border border-theme">Reset View</button>
                <span id="searchResultBadge" class="search-result-badge hidden"></span>
            </div>
            <!-- Filter Section: Tailwind ÊõøÊç¢ -->
            <div class="flex items-center gap-2 px-3 py-2 bg-muted rounded-lg text-sm mb-4" id="flameFilterSection">
                <span class="text-muted font-medium whitespace-nowrap">üîß Filter:</span>
                <div class="flex flex-wrap gap-1.5">
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-card border border-theme rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors text-base" data-filter="jvm" onclick="toggleFlameFilter('jvm')" title="JDK/JVM internal functions">
                        <span class="text-[11px]">‚òï</span> JVM
                    </div>
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-card border border-theme rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors text-base" data-filter="gc" onclick="toggleFlameFilter('gc')" title="Garbage Collection functions">
                        <span class="text-[11px]">üóëÔ∏è</span> GC
                    </div>
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-card border border-theme rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors text-base" data-filter="native" onclick="toggleFlameFilter('native')" title="Native/C++ runtime functions">
                        <span class="text-[11px]">‚öôÔ∏è</span> Native
                    </div>
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-card border border-theme rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors text-base" data-filter="kernel" onclick="toggleFlameFilter('kernel')" title="Linux kernel functions">
                        <span class="text-[11px]">üêß</span> Kernel
                    </div>
                    <div class="filter-chip inline-flex items-center gap-1 px-2.5 py-1 bg-card border border-theme rounded-full text-xs cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors text-base" data-filter="reflect" onclick="toggleFlameFilter('reflect')" title="Reflection and proxy functions">
                        <span class="text-[11px]">üîÑ</span> Reflect
                    </div>
                </div>
            </div>
            <div id="flame-details" class="flex flex-wrap gap-4 text-sm text-secondary mb-4">
                <div class="flex items-center gap-1.5">
                    <span class="font-medium">üìä Total Samples:</span>
                    <span id="flame-total-samples">-</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="font-medium">üìà Unique Functions:</span>
                    <span id="flame-unique-funcs">-</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="font-medium">üî• Max Depth:</span>
                    <span id="flame-max-depth">-</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="font-medium">üí° Tip:</span>
                    <span class="text-muted">Click frame to zoom, right-click to zoom out</span>
                </div>
            </div>
            <div id="flamegraph">
                <div class="loading text-center py-10 text-muted">Loading flame graph</div>
            </div>
        </div>

        <!-- Call Graph Panel: Alpine.js ÊéßÂà∂ÊòæÁ§∫ -->
        <div x-show="activePanel === 'callgraph'" x-cloak class="bg-card rounded-xl shadow-md p-5 border border-theme">
            <div class="tips">
                <span>üí° Drag nodes to reposition</span>
                <span>üîç Scroll to zoom</span>
                <span>üñ±Ô∏è Hover on nodes for details</span>
                <span>‚å®Ô∏è Arrow keys to navigate matches</span>
            </div>
            <!-- Thread Selector -->
            <div class="thread-selector-container" id="threadSelectorContainer">
                <span class="thread-selector-label"><span class="icon">üßµ</span>Thread View:</span>
                <div class="thread-selector-wrapper" id="threadSelectorWrapper">
                    <div class="thread-selector-trigger" onclick="toggleThreadDropdown()">
                        <span class="thread-selected-text" id="threadSelectedText">
                            <span class="global-icon">üåê</span> Global View (All Threads)
                        </span>
                        <span class="thread-selector-arrow">‚ñº</span>
                    </div>
                    <div class="thread-dropdown-container">
                        <div class="thread-search-box">
                            <input type="text" 
                                   class="thread-search-input" 
                                   id="threadSearchInput" 
                                   placeholder="Search threads by name, group, or TID..."
                                   oninput="handleThreadSearch(this.value)"
                                   onkeydown="handleThreadSearchKeydown(event)">
                        </div>
                        <div class="thread-dropdown" id="threadDropdown">
                            <!-- Dropdown items will be populated dynamically -->
                        </div>
                    </div>
                </div>
                <span class="thread-info-badge">
                    <span>Threads</span>
                    <span class="count" id="threadCount">0</span>
                </span>
            </div>
            <div class="controls">
                <input type="text" id="callgraphSearchInput" placeholder="Search function name..." onkeyup="handleCallGraphSearchKeyup(event)">
                <button onclick="searchCallGraph()">üîç Search</button>
                <button class="secondary" onclick="clearCallGraphSearch()">Clear</button>
                <div class="search-nav">
                    <button class="nav-btn" id="cgPrevBtn" onclick="navigateCallGraphMatch(-1)" disabled>‚Üê Prev</button>
                    <span class="search-counter" id="cgSearchCounter"></span>
                    <button class="nav-btn" id="cgNextBtn" onclick="navigateCallGraphMatch(1)" disabled>Next ‚Üí</button>
                </div>
                <div class="view-mode-switch">
                    <span class="switch-label left active">All</span>
                    <div class="switch-track" id="viewModeSwitch" onclick="toggleViewMode()" title="Toggle between All nodes and Focus mode">
                        <div class="switch-thumb"></div>
                    </div>
                    <span class="switch-label right">Focus</span>
                </div>
                <button class="secondary" onclick="fitCallGraph()">Fit to View</button>
                <button class="secondary" onclick="resetCallGraph()">Reset Layout</button>
            </div>
            <div class="filter-section" id="callgraphFilterSection">
                <span class="filter-label">üîß Filter:</span>
                <div class="filter-chips">
                    <div class="filter-chip" data-filter="jvm" onclick="toggleCallGraphFilter('jvm')" title="JDK/JVM internal functions">
                        <span class="chip-icon">‚òï</span> JVM
                    </div>
                    <div class="filter-chip" data-filter="gc" onclick="toggleCallGraphFilter('gc')" title="Garbage Collection functions">
                        <span class="chip-icon">üóëÔ∏è</span> GC
                    </div>
                    <div class="filter-chip" data-filter="native" onclick="toggleCallGraphFilter('native')" title="Native/C++ runtime functions">
                        <span class="chip-icon">‚öôÔ∏è</span> Native
                    </div>
                    <div class="filter-chip" data-filter="kernel" onclick="toggleCallGraphFilter('kernel')" title="Linux kernel functions">
                        <span class="chip-icon">üêß</span> Kernel
                    </div>
                    <div class="filter-chip" data-filter="reflect" onclick="toggleCallGraphFilter('reflect')" title="Reflection and proxy functions">
                        <span class="chip-icon">üîÑ</span> Reflect
                    </div>
                </div>
            </div>
            <div class="callgraph-stats" id="callgraphStats" style="display: none;">
                <div class="stat">
                    <span class="stat-label">üéØ Matches:</span>
                    <span class="stat-value" id="cgStatMatches">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">üìç Entry Points:</span>
                    <span class="stat-value" id="cgStatRoots">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">üîó Chain Depth:</span>
                    <span class="stat-value" id="cgStatDepth">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">üìä Visible Nodes:</span>
                    <span class="stat-value" id="cgStatVisible">0</span>
                </div>
            </div>
            <div class="callgraph-container">
                <div id="callgraph">
                    <div class="loading">Loading call graph</div>
                </div>
                <div class="callchain-sidebar" id="callchainSidebar">
                    <div class="callchain-header">
                        <span>üìã Call Chain</span>
                        <button class="callchain-close" onclick="toggleCallChainSidebar(false)">√ó</button>
                    </div>
                    <div class="callchain-content" id="callchainContent"></div>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #00c853;"></div>
                    <span>Entry Point (Root)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #7c4dff;"></div>
                    <span>Call Chain</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e040fb;"></div>
                    <span>Target (Match)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f8d568;"></div>
                    <span>Other Nodes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9c27b0; border: 1px dashed #9c27b0;"></div>
                    <span>Bridge Edge (filtered bypass)</span>
                </div>
            </div>
        </div>

        <!-- Top Functions Panel: Alpine.js ÊéßÂà∂ÊòæÁ§∫ -->
        <div x-show="activePanel === 'topfuncs'" x-cloak class="bg-card rounded-xl shadow-sm border border-theme overflow-hidden">
            <div class="px-6 py-4 border-b border-theme flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white">üìã</div>
                    <div>
                        <h2 class="text-base font-semibold text-base">All Functions (sorted by self %)</h2>
                        <p class="text-xs text-muted mt-0.5">üí° Click action buttons to search in Flame Graph or Call Graph</p>
                    </div>
                </div>
                <!-- View Toggle -->
                <div class="flex items-center gap-2">
                    <span class="text-xs text-muted">View:</span>
                    <button id="topFuncsViewTable" onclick="TopFuncsPanel.setView('table')" 
                        class="px-3 py-1.5 text-xs rounded-lg bg-primary text-white transition-colors">
                        üìã Table
                    </button>
                    <button id="topFuncsViewChart" onclick="TopFuncsPanel.setView('chart')" 
                        class="px-3 py-1.5 text-xs rounded-lg bg-muted text-secondary hover:bg-elevated transition-colors">
                        üìä Functions
                    </button>
                    <!-- Threads view is only available for Java analysis (cpu/alloc), not for pprof -->
                    <button id="topFuncsViewThreads" onclick="TopFuncsPanel.setView('threads')" 
                        x-show="analysisType === 'cpu' || analysisType === 'alloc'"
                        class="px-3 py-1.5 text-xs rounded-lg bg-muted text-secondary hover:bg-elevated transition-colors">
                        üßµ Threads
                    </button>
                </div>
            </div>
            
            <!-- Table View -->
            <div id="topFuncsTableView" class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-muted text-left">
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-12">#</th>
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Function</th>
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-48">Self %</th>
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-28 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="topFuncsAll" class="divide-y divide-theme"></tbody>
                </table>
            </div>
            
            <!-- Chart View -->
            <div id="topFuncsChartView" class="hidden p-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-4">
                        <label class="text-xs text-muted">
                            Show top 
                            <select id="topFuncsChartCount" onchange="TopFuncsPanel.updateChart()" 
                                class="mx-1 px-2 py-1 border border-theme rounded text-xs bg-card text-base">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                            </select>
                            functions
                        </label>
                        <label class="text-xs text-muted flex items-center gap-1">
                            <input type="checkbox" id="topFuncsChartShowOthers" onchange="TopFuncsPanel.updateChart()" checked>
                            Group remaining as "Others"
                        </label>
                    </div>
                    <div class="text-xs text-muted">
                        üí° Click on a bar to search in Flame Graph
                    </div>
                </div>
                <div id="topFuncsBarChart" style="width: 100%; height: 500px;"></div>
            </div>
            
            <!-- Thread Groups View -->
            <div id="topFuncsThreadsView" class="hidden p-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-4">
                        <label class="text-xs text-muted">
                            Show top 
                            <select id="topFuncsThreadCount" onchange="TopFuncsPanel.updateThreadChart()" 
                                class="mx-1 px-2 py-1 border border-theme rounded text-xs bg-card text-base">
                                <option value="8">8</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                            thread groups
                        </label>
                        <label class="text-xs text-muted flex items-center gap-1">
                            <input type="checkbox" id="topFuncsThreadShowOthers" onchange="TopFuncsPanel.updateThreadChart()" checked>
                            Group remaining as "Others"
                        </label>
                    </div>
                    <div class="text-xs text-muted">
                        üí° Click on a segment to filter threads
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div id="topFuncsThreadPie" style="width: 100%; height: 400px;"></div>
                    <div id="topFuncsThreadBar" style="width: 100%; height: 400px;"></div>
                </div>
                <div id="topFuncsThreadLegend" class="mt-4 p-3 bg-muted rounded-lg">
                    <div class="text-xs text-muted mb-2">Thread Group Details</div>
                    <div id="topFuncsThreadDetails" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 text-xs"></div>
                </div>
            </div>
        </div>

        <!-- Threads Panel: Enhanced CPU Thread Analysis -->
        <div x-show="activePanel === 'threads'" x-cloak class="bg-card rounded-xl shadow-sm border border-theme overflow-hidden">
            <div class="px-6 py-4 border-b border-theme flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-teal-500 to-cyan-500 flex items-center justify-center text-white">üßµ</div>
                    <div>
                        <h2 class="text-base font-semibold text-base">Thread Analysis</h2>
                        <p class="text-xs text-muted" id="cpu-threads-summary">Loading thread data...</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <input type="text" id="cpu-thread-search" placeholder="Search threads or functions..."
                        class="px-3 py-1.5 border border-theme rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 w-56 bg-card text-base">
                    <select id="cpu-thread-sort" class="px-2 py-1.5 border border-theme rounded text-sm focus:outline-none bg-card text-base">
                        <option value="samples-desc">Samples (High to Low)</option>
                        <option value="samples-asc">Samples (Low to High)</option>
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="percentage-desc">Percentage (High to Low)</option>
                    </select>
                    <button onclick="ThreadsPanel.refresh()" class="px-3 py-1.5 text-sm bg-primary text-white hover:bg-primary/90 rounded transition-colors">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            
            <!-- Thread Table Container -->
            <div class="overflow-x-auto">
                <table class="w-full" id="cpu-threads-table">
                    <thead>
                        <tr class="bg-muted text-left">
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-12">#</th>
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Thread Name</th>
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-24 text-right">TID</th>
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-28 text-right">Samples</th>
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-48">Percentage</th>
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider">Top Function</th>
                            <th class="px-6 py-3 text-xs font-semibold text-muted uppercase tracking-wider w-28 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cpu-threads-tbody" class="divide-y divide-theme">
                        <tr><td colspan="7" class="px-6 py-8 text-center text-muted">
                            <div class="animate-spin text-2xl mb-2">‚è≥</div>
                            <p>Loading thread analysis data...</p>
                        </td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div id="cpu-threads-pagination" class="px-6 py-3 border-t border-theme flex items-center justify-between bg-muted">
                <div class="text-sm text-muted" id="cpu-threads-page-info">Showing 0 threads</div>
                <div class="flex items-center gap-1" id="cpu-threads-page-buttons"></div>
            </div>
        </div>

        <!-- Heap Biggest Objects Panel: Alpine.js ÊéßÂà∂ÊòæÁ§∫ -->
        <div x-show="activePanel === 'heaptreemap'" x-cloak class="bg-card rounded-xl shadow-md p-4 border border-theme">
            <div class="flex items-center justify-between mb-3 pb-2 border-b-2 border-primary">
                <h2 class="text-base font-semibold text-base">üì¶ Biggest Objects</h2>
                <div class="flex items-center gap-1.5">
                    <button onclick="HeapBiggestObjects.expandAll()" class="px-2 py-1 text-[11px] bg-muted hover:bg-elevated rounded transition-colors text-base">
                        Expand All
                    </button>
                    <button onclick="HeapBiggestObjects.collapseAll()" class="px-2 py-1 text-[11px] bg-muted hover:bg-elevated rounded transition-colors text-base">
                        Collapse All
                    </button>
                    <button onclick="HeapBiggestObjects.refresh()" class="px-2 py-1 text-[11px] bg-primary text-white hover:bg-primary/90 rounded transition-colors">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            <p class="text-[10px] text-muted mb-2">
                <span>üí° Objects with largest retained memory - click to see field details</span>
                <span class="ml-3">üìä Retained size = object size + all objects it keeps alive</span>
            </p>
            
            <!-- ÁªüËÆ°ÊëòË¶Å -->
            <div id="biggestObjectsSummary" class="mb-3"></div>
            
            <!-- ÊêúÁ¥¢ÂíåÊéíÂ∫èÂ∑•ÂÖ∑Ê†è -->
            <div class="flex flex-wrap items-center gap-2 mb-2 p-2 bg-muted rounded-lg">
                <div class="flex-1 min-w-[180px]">
                    <input type="text" id="biggestObjectsSearch" placeholder="Search by class name or object ID..."
                        onkeyup="HeapBiggestObjects.filter(this.value)"
                        class="w-full px-2 py-1.5 border border-theme rounded text-xs focus:outline-none focus:ring-2 focus:ring-primary/50 bg-card text-base">
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="text-[10px] text-muted">Sort by:</span>
                    <button onclick="HeapBiggestObjects.sort('retained')" data-sort="retained" 
                        class="sort-btn px-2 py-1 text-[10px] rounded transition-colors bg-primary text-white">
                        Retained <span class="sort-arrow">‚Üì</span>
                    </button>
                    <button onclick="HeapBiggestObjects.sort('shallow')" data-sort="shallow"
                        class="sort-btn px-2 py-1 text-[10px] rounded transition-colors bg-muted text-secondary">
                        Shallow <span class="sort-arrow">‚Üì</span>
                    </button>
                    <button onclick="HeapBiggestObjects.sort('class')" data-sort="class"
                        class="sort-btn px-2 py-1 text-[10px] rounded transition-colors bg-muted text-secondary">
                        Class <span class="sort-arrow">‚Üì</span>
                    </button>
                    <button onclick="HeapBiggestObjects.sort('fields')" data-sort="fields"
                        class="sort-btn px-2 py-1 text-[10px] rounded transition-colors bg-muted text-secondary">
                        Fields <span class="sort-arrow">‚Üì</span>
                    </button>
                </div>
            </div>
            
            <!-- ÂØπË±°ÂàóË°® -->
            <div id="biggestObjectsList" class="max-h-[calc(100vh-320px)] min-h-[400px] overflow-y-auto border border-theme rounded-lg bg-card">
                <div class="text-center py-8 text-muted">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-3 border-primary border-t-transparent"></div>
                    <p class="mt-3 text-sm">Loading biggest objects...</p>
                </div>
            </div>
        </div>

        <!-- Heap GC Roots Panel: Alpine.js ÊéßÂà∂ÊòæÁ§∫ -->
        <div x-show="activePanel === 'heapgcroots'" x-cloak class="bg-card rounded-xl shadow-md p-5 border border-theme">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-base">üå≥ GC Roots</h2>
            <p class="text-xs text-muted mb-4 space-x-4">
                <span>üí° GC Roots are objects that are always reachable and prevent garbage collection</span>
                <span>üîç Click to expand and see retained objects</span>
            </p>
            <div class="flex gap-6 mb-4" id="gcRootsSummary">
                <div class="flex flex-col items-center">
                    <span class="text-2xl font-bold text-primary" id="gcRootsTotalCount">-</span>
                    <span class="text-sm text-muted">Total GC Roots</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-2xl font-bold text-primary" id="gcRootsClassCount">-</span>
                    <span class="text-sm text-muted">Root Classes</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-2xl font-bold text-primary" id="gcRootsRetainedSize">-</span>
                    <span class="text-sm text-muted">Total Retained Size</span>
                </div>
            </div>
            <div class="flex gap-2.5 mb-4">
                <input type="text" id="gcRootsSearch" placeholder="Filter by class name or root type..." onkeyup="HeapGCRoots.filter()"
                    class="flex-1 px-3 py-2 border border-theme rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 bg-card text-base">
                <select id="gcRootsTypeFilter" onchange="HeapGCRoots.filter()"
                    class="px-3 py-2 border border-theme rounded-lg text-sm bg-card text-base focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <option value="">All Types</option>
                    <option value="STICKY_CLASS">Sticky Class</option>
                    <option value="JAVA_FRAME">Java Frame</option>
                    <option value="THREAD_OBJECT">Thread Object</option>
                    <option value="JNI_GLOBAL">JNI Global</option>
                    <option value="JNI_LOCAL">JNI Local</option>
                    <option value="MONITOR_USED">Monitor Used</option>
                    <option value="NATIVE_STACK">Native Stack</option>
                    <option value="SYSTEM_CLASS">System Class</option>
                </select>
                <button onclick="HeapGCRoots.refresh()" class="px-3 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary/90">
                    üîÑ Refresh
                </button>
            </div>
            <div class="gc-roots-table-container overflow-x-auto">
                <table class="gc-roots-table w-full" id="gcRootsTable">
                    <thead>
                        <tr>
                            <th class="w-[30px]"></th>
                            <th class="w-[140px]">Root Type</th>
                            <th>Class Name</th>
                            <th class="w-[120px]">Shallow</th>
                            <th class="w-[140px]">Retained</th>
                        </tr>
                    </thead>
                    <tbody id="gcRootsTableBody">
                        <tr><td colspan="5" class="loading text-center py-10 text-muted">Loading GC Roots...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Heap Merged Paths Panel: Alpine.js ÊéßÂà∂ÊòæÁ§∫ -->
        <div x-show="activePanel === 'heapmergedpaths'" x-cloak class="bg-card rounded-xl shadow-md p-5 border border-theme">
            <h2 class="text-lg font-semibold mb-4 pb-2.5 border-b-2 border-primary text-base">üîÄ Merged Paths (Retainers)</h2>
            <p class="text-xs text-muted mb-4 space-x-4">
                <span>üí° Â±ïÁ§∫ÂÜÖÂ≠òÂç†Áî®Â§ßÁ±ªË¢´Âì™‰∫õÁ±ªÊåÅÊúâÔºàRetained byÔºâ</span>
                <span>üîç ÁÇπÂáªÁ±ªÂêçÂ±ïÂºÄÊü•ÁúãËØ¶ÁªÜÁöÑÊåÅÊúâËÄÖÂàóË°®</span>
                <span>üìä Êåâ‰øùÁïôÂÜÖÂ≠òÂ§ßÂ∞èÊéíÂ∫è</span>
            </p>
            <div class="merged-paths-container" id="mergedPathsContainer">
                <div class="loading text-center py-10 text-muted">Âä†ËΩΩ Retainer Êï∞ÊçÆ‰∏≠...</div>
            </div>
        </div>

        <!-- Heap Histogram Panel: Alpine.js ÊéßÂà∂ÊòæÁ§∫ -->
        <div x-show="activePanel === 'heaphistogram'" x-cloak class="bg-card rounded-xl shadow-md p-5 border border-theme">
            <div class="flex items-center justify-between mb-4 pb-2.5 border-b-2 border-primary">
                <h2 class="text-lg font-semibold text-base">üìä Class Histogram</h2>
                <div class="text-sm text-muted" id="heapHistogramStats"></div>
            </div>
            
            <!-- ÊêúÁ¥¢ÂíåËßÜÂõæÂàáÊç¢ -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                <div class="flex items-center gap-2">
                    <input type="text" id="heapClassSearch" placeholder="ÊêúÁ¥¢Á±ªÂêç (Â¶Ç HashMap, byte[], String)..." 
                        onkeyup="if(event.key==='Enter') HeapHistogram.filter(this.value)"
                        class="w-80 px-4 py-2.5 border border-theme rounded-lg text-sm text-base placeholder-muted focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary bg-card">
                    <button onclick="HeapHistogram.filter(document.getElementById('heapClassSearch').value)" 
                        class="px-5 py-2.5 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">
                        üîç ÊêúÁ¥¢
                    </button>
                    <button onclick="HeapHistogram.clearSearch()" 
                        class="px-5 py-2.5 bg-elevated text-base rounded-lg text-sm font-medium hover:bg-muted transition-colors border border-theme">
                        Ê∏ÖÈô§
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <button class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium" id="heapViewFlat" 
                        onclick="HeapHistogram.setViewMode('flat')">
                        üìã Âπ≥Èì∫ËßÜÂõæ
                    </button>
                    <button class="px-4 py-2 bg-muted text-secondary rounded-lg text-sm font-medium hover:bg-elevated" id="heapViewPackage" 
                        onclick="HeapHistogram.setViewMode('package')">
                        üì¶ ÂåÖËßÜÂõæ
                    </button>
                </div>
            </div>
            
            <!-- Ë°®Ê†ºÂÆπÂô® -->
            <div id="heapHistogramContainer" class="overflow-x-auto">
                <div id="heapFlatView">
                    <table class="w-full" id="heapHistogramTable">
                        <thead>
                            <tr class="bg-muted text-left">
                                <th class="px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider text-center w-12">#</th>
                                <th class="px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider sortable cursor-pointer hover:bg-elevated transition-colors" 
                                    data-sort="name" onclick="HeapHistogram.sort('name')">
                                    Class <span class="sort-arrow ml-1"></span>
                                </th>
                                <th class="px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider text-right w-28 sortable cursor-pointer hover:bg-elevated transition-colors" 
                                    data-sort="count" onclick="HeapHistogram.sort('count')">
                                    Count <span class="sort-arrow ml-1"></span>
                                </th>
                                <th class="px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider text-right w-40 sortable cursor-pointer hover:bg-elevated transition-colors active" 
                                    data-sort="shallow" onclick="HeapHistogram.sort('shallow')">
                                    Shallow Size <span class="sort-arrow ml-1">‚ñº</span>
                                </th>
                                <th class="px-4 py-3 text-xs font-semibold text-muted uppercase tracking-wider text-right w-40 sortable cursor-pointer hover:bg-elevated transition-colors" 
                                    data-sort="retained" onclick="HeapHistogram.sort('retained')">
                                    Retained Size <span class="sort-arrow ml-1"></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="heapClassTableBody" class="divide-y divide-theme"></tbody>
                    </table>
                    <!-- ÂàÜÈ°µÊéß‰ª∂ -->
                    <div id="heapPagination"></div>
                </div>
                <div id="heapPackageView" class="hidden">
                    <div id="heapPackageGroups"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- Node Tooltip -->
    <div id="nodeTooltip" class="hidden"></div>

    <!-- Alpine.js x-cloak style & Theme Picker -->
    <style>
        [x-cloak] { display: none !important; }
        
        /* Tab active state - uses CSS variables */
        .tab-btn.tab-active {
            background: var(--gradient-primary) !important;
            color: rgb(var(--color-text-inverted)) !important;
        }
        
        /* Theme picker dropdown */
        .theme-picker-dropdown {
            display: none;
        }
        .theme-picker-dropdown.show {
            display: block;
            animation: fadeIn 0.15s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Theme option active state */
        .theme-option.active {
            background: rgb(var(--color-bg-active));
        }
        .theme-option.active::before {
            content: '‚úì';
            position: absolute;
            right: 12px;
            color: rgb(var(--color-primary));
            font-weight: bold;
        }
        .theme-option {
            position: relative;
        }
        
        /* Dark mode specific overrides for third-party components */
        [data-theme="dark"] .d3-flame-graph text {
            fill: rgb(var(--color-text-base)) !important;
        }
        [data-theme="dark"] .tippy-box[data-theme~='flame'] {
            background: rgb(var(--color-bg-card));
            color: rgb(var(--color-text-base));
        }
        [data-theme="dark"] .tippy-box[data-theme~='flame'] > .tippy-arrow::before {
            border-right-color: rgb(var(--color-bg-card));
        }
    </style>

    <!-- Alpine.js App State -->
    <script>
        function appState() {
            return {
                // State
                tasks: [],
                currentTask: '',
                loading: false,
                activePanel: 'overview',
                analysisType: 'cpu', // 'cpu', 'heap', 'alloc', or 'pprof-all'
                pprofSubType: 'cpu', // For pprof-all mode: 'cpu', 'heap', 'goroutine', 'block', 'mutex'
                summaryData: null,

                // Initialize
                async init() {
                    // Initialize modules
                    FlameGraph.init();
                    CallGraph.init();
                    HeapAnalysis.init();

                    // Listen for pprof sub-type changes
                    window.addEventListener('pprof-subtype-change', (e) => {
                        this.loadPProfSubType(e.detail);
                    });

                    // Load tasks
                    await this.loadTasks();
                },

                // Load task list
                async loadTasks() {
                    this.loading = true;
                    try {
                        this.tasks = await API.getTasks() || [];
                        if (this.tasks.length > 0) {
                            this.currentTask = this.tasks[0].id;
                            await this.loadTask(this.currentTask);
                        }
                    } catch (err) {
                        console.error('Failed to load tasks:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                // Load specific task
                async loadTask(taskId) {
                    this.currentTask = taskId;
                    this.loading = true;
                    
                    // Reset TopFuncsPanel cached data when task changes
                    if (typeof TopFuncsPanel !== 'undefined' && TopFuncsPanel.reset) {
                        TopFuncsPanel.reset();
                    }
                    
                    try {
                        await this.loadSummary(taskId);
                        if (this.analysisType === 'heap') {
                            HeapAnalysis.renderAnalysis(this.summaryData);
                        } else if (this.analysisType === 'pprof-all') {
                            // For pprof-all, load the default sub-type (cpu)
                            await this.loadPProfSubType(this.pprofSubType || 'cpu');
                        } else {
                            // Determine flame graph / call graph type based on analysis type
                            const graphType = this.analysisType === 'alloc' ? 'memory' : 'cpu';
                            await Promise.all([
                                FlameGraph.load(taskId, graphType),
                                CallGraph.load(taskId, graphType)
                            ]);
                        }
                    } finally {
                        this.loading = false;
                    }
                },

                // Load summary data
                async loadSummary(taskId) {
                    try {
                        this.summaryData = await API.getSummary(taskId);
                        this.detectAnalysisType();
                        this.renderSummary();
                    } catch (err) {
                        console.error('Failed to load summary:', err);
                    }
                },

                // Detect analysis type from data
                detectAnalysisType() {
                    const data = this.summaryData;
                    if (!data) return;
                    
                    const taskType = data.task_type || '';
                    const metadata = data.metadata || {};
                    const taskTypeName = metadata.task_type_name || taskType;
                    const mode = metadata.mode || '';

                    // Check for pprof-all mode first
                    if (mode === 'pprof-all' || taskType === 'pprof_all' || data.profile_sets) {
                        this.analysisType = 'pprof-all';
                        // Initialize pprof sub-type to cpu by default
                        if (!this.pprofSubType) {
                            this.pprofSubType = 'cpu';
                        }
                    } else if (taskTypeName === 'java_heap' || taskType === 'java_heap' ||
                        (data.data && data.data.total_heap_size !== undefined)) {
                        this.analysisType = 'heap';
                    } else if (mode === 'java-alloc' || taskTypeName === 'java_alloc' ||
                        (data.data && data.data.total_allocations !== undefined)) {
                        this.analysisType = 'alloc';
                    } else {
                        this.analysisType = 'cpu';
                    }
                },

                // Render summary data
                renderSummary() {
                    const data = this.summaryData;
                    if (!data) return;

                    // Hide pprof-all specific elements by default
                    this.hidePProfAllElements();

                    if (this.analysisType === 'heap') {
                        HeapAnalysis.renderOverview(data);
                        this.renderTaskMetadata(data.metadata);
                        return;
                    }

                    if (this.analysisType === 'pprof-all') {
                        this.renderPProfAllOverview(data);
                        this.renderTaskMetadata(data.metadata);
                        return;
                    }

                    // Stats for CPU/Allocation analysis
                    document.getElementById('totalSamples').textContent = Utils.formatNumber(data.total_records || 0);
                    document.getElementById('topFuncsCount').textContent = (data.top_items || []).length || Object.keys(data.top_funcs || {}).length;
                    document.getElementById('threadsCount').textContent = (data.threads || []).length;
                    document.getElementById('taskUUID').textContent = data.task_uuid || '-';

                    this.renderTaskMetadata(data.metadata);
                    this.renderTopFunctions(data);
                    this.renderThreads(data);
                },

                // Clear pprof-all specific elements content
                // Note: Visibility is controlled by Alpine.js x-show directive
                hidePProfAllElements() {
                    const profileCards = document.getElementById('pprofProfileCards');
                    const leakReports = document.getElementById('pprofLeakReports');
                    
                    if (profileCards) {
                        profileCards.innerHTML = '';
                    }
                    if (leakReports) {
                        leakReports.innerHTML = '';
                    }
                },

                // Render pprof-all overview
                renderPProfAllOverview(data) {
                    // Update stats
                    document.getElementById('totalSamples').textContent = Utils.formatNumber(data.total_records || 0);
                    document.getElementById('topFuncsCount').textContent = (data.top_items || []).length;
                    
                    // Count profile types as "threads" for pprof-all
                    const profileSets = data.profile_sets || {};
                    const profileCount = Object.keys(profileSets).filter(k => profileSets[k]?.total_samples > 0).length;
                    document.getElementById('threadsCount').textContent = profileCount + ' profiles';
                    document.getElementById('taskUUID').textContent = data.task_uuid || '-';

                    // Render top functions if available
                    this.renderTopFunctions(data);

                    // Render pprof-specific overview cards
                    this.renderPProfProfileCards(profileSets);
                    this.renderPProfLeakReports(data.leak_reports || {});
                },

                // Render pprof profile cards
                renderPProfProfileCards(profileSets) {
                    const container = document.getElementById('pprofProfileCards');
                    if (!container) return;

                    const profileIcons = {
                        'cpu': 'üî•',
                        'heap': 'üì¶',
                        'goroutine': 'üßµ',
                        'block': '‚è∏Ô∏è',
                        'mutex': 'üîí',
                        'allocs': 'üìà'
                    };

                    const profileNames = {
                        'cpu': 'CPU Profile',
                        'heap': 'Heap Memory',
                        'goroutine': 'Goroutines',
                        'block': 'Block Profile',
                        'mutex': 'Mutex Profile',
                        'allocs': 'Allocations'
                    };

                    let html = '';
                    for (const [type, data] of Object.entries(profileSets)) {
                        if (!data || data.total_samples === 0) continue;
                        const icon = profileIcons[type] || 'üìä';
                        const name = profileNames[type] || type;
                        const isActive = this.pprofSubType === type;
                        
                        html += `
                            <div class="pprof-profile-card ${isActive ? 'active' : ''} cursor-pointer p-4 bg-card rounded-xl border-2 ${isActive ? 'border-primary' : 'border-theme'} hover:border-primary/50 transition-all"
                                 onclick="window.dispatchEvent(new CustomEvent('pprof-subtype-change', {detail: '${type}'}))">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${icon}</span>
                                    <div>
                                        <div class="font-semibold text-base">${name}</div>
                                        <div class="text-sm text-secondary">${Utils.formatNumber(data.total_samples)} samples</div>
                                        <div class="text-xs text-muted">${data.file_count} file(s)</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    container.innerHTML = html;
                    // Visibility is controlled by Alpine.js x-show directive
                },

                // Render pprof leak reports
                renderPProfLeakReports(leakReports, highlightType = null) {
                    const container = document.getElementById('pprofLeakReports');
                    if (!container) return;

                    if (Object.keys(leakReports).length === 0) {
                        container.innerHTML = '<div class="text-muted text-sm">No leak detection data available</div>';
                        return;
                    }

                    const severityColors = {
                        'none': 'leak-severity-none',
                        'low': 'leak-severity-low',
                        'medium': 'leak-severity-medium',
                        'high': 'leak-severity-high',
                        'critical': 'leak-severity-critical'
                    };

                    const severityIcons = {
                        'none': '‚úÖ',
                        'low': '‚ö†Ô∏è',
                        'medium': 'üî∂',
                        'high': 'üî¥',
                        'critical': 'üö®'
                    };

                    // Sort entries to show highlighted type first
                    let entries = Object.entries(leakReports);
                    if (highlightType) {
                        entries = entries.sort((a, b) => {
                            if (a[0] === highlightType) return -1;
                            if (b[0] === highlightType) return 1;
                            return 0;
                        });
                    }

                    let html = '';
                    for (const [type, report] of entries) {
                        const severity = report.severity || 'none';
                        const colorClass = severityColors[severity] || severityColors['none'];
                        const icon = severityIcons[severity] || 'üìä';
                        const typeName = type === 'heap' ? 'Memory Leak' : 'Goroutine Leak';
                        const isHighlighted = highlightType === type;
                        
                        html += `
                            <div class="leak-card p-4 bg-card rounded-xl border-2 ${isHighlighted ? 'border-primary shadow-md' : 'border-theme'} shadow-sm transition-all">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-semibold text-base">${typeName}</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${colorClass}">${icon} ${severity.toUpperCase()}</span>
                                </div>
                                <p class="text-sm text-secondary mb-2">${report.conclusion || 'No conclusion'}</p>
                                <div class="flex items-center gap-4 text-xs text-muted">
                                    <span>Growth: ${report.growth_percent?.toFixed(2) || 0}%</span>
                                    <span>Items: ${report.items_count || 0}</span>
                                </div>
                            </div>
                        `;
                    }

                    container.innerHTML = html;
                    // Visibility is controlled by Alpine.js x-show directive
                },

                // Load pprof sub-type data
                async loadPProfSubType(subType) {
                    this.pprofSubType = subType;
                    
                    // Clear TopFuncsPanel thread groups data when sub-type changes
                    // This forces a reload when the user switches to threads view
                    if (typeof TopFuncsPanel !== 'undefined' && TopFuncsPanel.reset) {
                        TopFuncsPanel.reset();
                    }
                    
                    // Re-render profile cards to update active state
                    if (this.summaryData?.profile_sets) {
                        this.renderPProfProfileCards(this.summaryData.profile_sets);
                    }

                    // Map sub-type to flame graph type
                    const fgTypeMap = {
                        'cpu': 'cpu',
                        'heap': 'pprof-heap-inuse',
                        'goroutine': 'goroutine',
                        'block': 'block',
                        'mutex': 'mutex'
                    };
                    const fgType = fgTypeMap[subType] || 'cpu';

                    // Load flame graph and call graph for the selected sub-type
                    await Promise.all([
                        FlameGraph.load(this.currentTask, fgType),
                        subType === 'cpu' ? CallGraph.load(this.currentTask, 'cpu') : Promise.resolve()
                    ]);

                    // Update Top Functions from the loaded flame graph data
                    this.updateTopFunctionsFromFlameGraph();

                    // Update Leak Reports to show the current profile type
                    this.updateLeakReportsForSubType(subType);
                },

                // Update Top Functions display from flame graph data
                updateTopFunctionsFromFlameGraph() {
                    const topFuncs = FlameGraph.getTopFunctions();
                    if (topFuncs && topFuncs.length > 0) {
                        // Convert to the format expected by renderTopFunctions
                        const data = {
                            top_items: topFuncs.map(f => ({
                                name: f.name,
                                percentage: f.percentage || 0,
                                samples: f.samples || 0
                            }))
                        };
                        this.renderTopFunctions(data);
                    }
                },

                // Update Leak Reports to highlight the current profile type
                updateLeakReportsForSubType(subType) {
                    const leakReports = this.summaryData?.leak_reports || {};
                    
                    // Update the leak report cards to highlight the current sub-type
                    const container = document.getElementById('pprofLeakReports');
                    if (!container) return;

                    // Re-render with the current sub-type highlighted
                    this.renderPProfLeakReports(leakReports, subType);
                },

                // Render task metadata
                renderTaskMetadata(metadata) {
                    const card = document.getElementById('taskMetadataCard');
                    if (!metadata) {
                        card.style.display = 'none';
                        return;
                    }

                    card.style.display = 'block';

                    // Use mode field (new format) or fall back to task_type_name (legacy)
                    const modeName = metadata.mode || metadata.task_type_name || 'unknown';
                    const modeClass = this.getModeClass(modeName);
                    const modeIcon = this.getModeIcon(modeName);
                    document.getElementById('metaTaskType').innerHTML = `<span class="type-badge ${modeClass}">${modeIcon} ${modeName.toUpperCase()}</span>`;

                    // Use profile field (new format) or fall back to profiler_name (legacy)
                    const profileName = metadata.profile || metadata.profiler_name || 'unknown';
                    const profileIcon = this.getProfileIcon(profileName);
                    document.getElementById('metaProfiler').innerHTML = `<span class="profiler-badge">${profileIcon} ${profileName}</span>`;

                    document.getElementById('metaInputFile').textContent = metadata.input_file || '-';
                    document.getElementById('metaCreatedAt').textContent = metadata.created_at ? Utils.formatDateTime(metadata.created_at) : '-';
                    document.getElementById('metaAnalysisTime').textContent = metadata.analysis_time_ms ? Utils.formatDuration(metadata.analysis_time_ms) : '-';
                    document.getElementById('metaTaskUUID').textContent = this.summaryData?.task_uuid || '-';
                },

                // Render top functions
                renderTopFunctions(data) {
                    let funcs = [];
                    if (data.top_items && data.top_items.length > 0) {
                        funcs = data.top_items.map(item => ({ name: item.name, self: item.percentage || 0 }));
                    } else if (data.top_funcs) {
                        funcs = Object.entries(data.top_funcs)
                            .map(([name, val]) => ({ name, self: val.self || 0 }))
                            .sort((a, b) => b.self - a.self);
                    }

                    const self = this;
                    const isAllocMode = this.analysisType === 'alloc';
                    
                    const renderRow = (f, i) => {
                        // Format function name with allocation badge if applicable
                        const formatted = Utils.formatFunctionName(f.name, { showBadge: isAllocMode });
                        const displayName = Utils.escapeHtml(formatted.displayName);
                        const badge = formatted.badge || '';
                        // Use original name for search/copy operations
                        const originalName = f.name;
                        const escapedOriginal = Utils.escapeHtml(originalName).replace(/'/g, "\\'");
                        
                        return `
                        <tr class="hover:bg-muted transition-colors">
                            <td class="px-6 py-4 text-sm text-muted font-medium">${i + 1}</td>
                            <td class="px-6 py-4">
                                <span class="font-mono text-sm text-base cursor-pointer hover:text-primary hover:underline" title="Click to copy: ${Utils.escapeHtml(originalName)}" onclick="Utils.copyToClipboard('${escapedOriginal}')">${displayName}</span>${badge}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="flex-1 h-2 bg-elevated rounded-full overflow-hidden max-w-[120px]">
                                        <div class="h-full bg-gradient-to-r from-primary to-secondary rounded-full transition-all duration-300" style="width: ${Math.min(f.self, 100)}%"></div>
                                    </div>
                                    <span class="text-sm font-semibold text-secondary w-16 text-right">${f.self.toFixed(2)}%</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button class="w-8 h-8 rounded-lg bg-gradient-to-r from-orange-500 to-red-500 text-white flex items-center justify-center hover:scale-110 transition-transform" title="Search in Flame Graph" onclick="App.searchInFlameGraph('${escapedOriginal}')">üî•</button>
                                    <button class="w-8 h-8 rounded-lg bg-gradient-to-r from-primary to-secondary text-white flex items-center justify-center hover:scale-110 transition-transform" title="Search in Call Graph" onclick="App.searchInCallGraph('${escapedOriginal}')">üìà</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    };

                    document.getElementById('topFuncsPreview').innerHTML = funcs.slice(0, 5).map(renderRow).join('');
                    document.getElementById('topFuncsAll').innerHTML = funcs.map(renderRow).join('');
                    
                    // Update TopFuncsPanel data for chart view
                    if (typeof TopFuncsPanel !== 'undefined') {
                        TopFuncsPanel.setData(funcs);
                    }
                },

                // Render threads
                renderThreads(data) {
                    const threadList = document.getElementById('threadList');
                    // Skip if threadList element doesn't exist (removed from UI)
                    if (!threadList) return;
                    
                    threadList.innerHTML = (data.threads || []).map((t, i) => `
                        <li class="flex items-center justify-between px-6 py-4 hover:bg-muted transition-colors">
                            <div class="flex items-center gap-3">
                                <span class="w-6 h-6 rounded-full bg-gradient-to-br from-teal-500 to-cyan-500 text-white text-xs flex items-center justify-center font-medium">${i + 1}</span>
                                <span class="font-mono text-sm text-base">${Utils.escapeHtml(t.thread_name || 'Unknown')}</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-20 h-1.5 bg-elevated rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-teal-500 to-cyan-500 rounded-full" style="width: ${Math.min(t.percentage || 0, 100)}%"></div>
                                    </div>
                                    <span class="text-sm text-secondary w-14 text-right">${(t.percentage || 0).toFixed(2)}%</span>
                                </div>
                                <span class="text-xs text-muted">${Utils.formatNumber(t.samples)} samples</span>
                            </div>
                        </li>
                    `).join('');
                },

                // Show panel
                showPanel(panelId) {
                    this.activePanel = panelId;

                    // Trigger panel-specific actions after DOM update
                    if (panelId === 'flamegraph' && FlameGraph.getData()) {
                        // Á≠âÂæÖ Alpine.js Êõ¥Êñ∞ DOM ÂêéÂÜçÊ∏≤ÊüìÁÅ´ÁÑ∞Âõæ
                        this.$nextTick(() => {
                            requestAnimationFrame(() => FlameGraph.render());
                        });
                    } else if (panelId === 'heaphistogram') {
                        // Á≠âÂæÖ Alpine.js Êõ¥Êñ∞ DOM ÂêéÂÜçÊ∏≤Êüì Class Histogram
                        const self = this;
                        this.$nextTick(() => {
                            requestAnimationFrame(() => {
                                if (typeof HeapHistogram !== 'undefined') {
                                    // È¶ñÂÖàÂ∞ùËØï‰ªé HeapHistogram Ê®°ÂùóËé∑ÂèñÊï∞ÊçÆÔºàÂèØËÉΩÂ∑≤ÈÄöËøá dataLoaded ‰∫ã‰ª∂Âä†ËΩΩÔºâ
                                    let classData = HeapHistogram.getData();
                                    console.log('[showPanel] heaphistogram - HeapHistogram.getData():', classData ? classData.length : 0, 'items');
                                    
                                    // Â¶ÇÊûúÊ®°ÂùóÂÜÖÈÉ®Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªé HeapCore Ëé∑Âèñ
                                    if (!classData || classData.length === 0) {
                                        classData = HeapCore.getState('classData');
                                        console.log('[showPanel] heaphistogram - HeapCore.getState(classData):', classData ? classData.length : 0, 'items');
                                    }
                                    
                                    // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØïÈáçÊñ∞Âä†ËΩΩ
                                    if ((!classData || classData.length === 0) && self.summaryData) {
                                        console.log('[showPanel] heaphistogram - reloading data from summaryData');
                                        HeapCore.loadAnalysisData(self.summaryData);
                                        classData = HeapCore.getState('classData');
                                        console.log('[showPanel] heaphistogram - after reload, classData:', classData ? classData.length : 0, 'items');
                                    }
                                    
                                    if (classData && classData.length > 0) {
                                        HeapHistogram.render(classData);
                                    } else {
                                        console.warn('[showPanel] No classData available, summaryData:', self.summaryData ? 'present' : 'null');
                                        if (self.summaryData) {
                                            console.log('[showPanel] summaryData keys:', Object.keys(self.summaryData));
                                            console.log('[showPanel] summaryData.top_items:', self.summaryData.top_items ? self.summaryData.top_items.length : 0);
                                            console.log('[showPanel] summaryData.data:', self.summaryData.data ? 'present' : 'null');
                                            if (self.summaryData.data) {
                                                console.log('[showPanel] summaryData.data.top_classes:', self.summaryData.data.top_classes ? self.summaryData.data.top_classes.length : 0);
                                            }
                                        }
                                        // ÊòæÁ§∫Á©∫Áä∂ÊÄÅÊèêÁ§∫
                                        const tbody = document.getElementById('heapClassTableBody');
                                        if (tbody) {
                                            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-muted">No class data available. Please check if the heap dump was parsed correctly.</td></tr>';
                                        }
                                    }
                                } else {
                                    console.warn('[showPanel] HeapHistogram module not defined');
                                }
                            });
                        });
                    } else if (panelId === 'heaptreemap') {
                        // Á≠âÂæÖ Alpine.js Êõ¥Êñ∞ DOM ÂêéÂÜçÊ∏≤Êüì biggest objects
                        this.$nextTick(() => {
                            requestAnimationFrame(() => {
                                // Âä†ËΩΩ Biggest Objects Êï∞ÊçÆ
                                if (typeof HeapBiggestObjects !== 'undefined') {
                                    HeapBiggestObjects.loadBiggestObjects(this.currentTask);
                                }
                            });
                        });
                    } else if (panelId === 'threads') {
                        // Âä†ËΩΩÁ∫øÁ®ãÂàÜÊûêÊï∞ÊçÆ
                        this.$nextTick(() => {
                            requestAnimationFrame(() => {
                                if (typeof ThreadsPanel !== 'undefined') {
                                    ThreadsPanel.init();
                                    ThreadsPanel.load(this.currentTask);
                                }
                            });
                        });
                    } else if (panelId === 'topfuncs') {
                        // ÂΩìÂàáÊç¢Âà∞ Top Functions Èù¢ÊùøÊó∂ÔºåÂ¶ÇÊûúÂΩìÂâçÊòØ threads ËßÜÂõæÔºåËß¶ÂèëÊï∞ÊçÆÈáçÊñ∞Âä†ËΩΩ
                        this.$nextTick(() => {
                            requestAnimationFrame(() => {
                                if (typeof TopFuncsPanel !== 'undefined') {
                                    const currentView = TopFuncsPanel.getView();
                                    if (currentView === 'threads') {
                                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÈáçÊñ∞Âä†ËΩΩ
                                        const threadData = TopFuncsPanel.getThreadGroupsData();
                                        if (!threadData || threadData.length === 0) {
                                            TopFuncsPanel.loadThreadGroups();
                                        }
                                    }
                                }
                            });
                        });
                    } else if (panelId === 'callgraph') {
                        // ÂΩìÂàáÊç¢Âà∞ Call Graph Èù¢ÊùøÊó∂ÔºåÊ£ÄÊü•‰∏ªÈ¢òÊòØÂê¶Â∑≤Êõ¥ÊîπÂπ∂ÈáçÊñ∞Ê∏≤Êüì
                        this.$nextTick(() => {
                            requestAnimationFrame(() => {
                                if (typeof CallGraph !== 'undefined' && CallGraph.checkThemeAndRerender) {
                                    CallGraph.checkThemeAndRerender();
                                }
                            });
                        });
                    } else if (panelId === 'leakreport') {
                        // Âä†ËΩΩÊ≥ÑÊºèÊ£ÄÊµãÊä•Âëä
                        this.$nextTick(() => {
                            requestAnimationFrame(() => {
                                this.loadLeakReportDetail();
                            });
                        });
                    }
                },

                // Load detailed leak report
                async loadLeakReportDetail() {
                    const container = document.getElementById('leakReportDetail');
                    if (!container) return;

                    try {
                        const response = await fetch(`/api/pprof/leak-report?task=${this.currentTask}`);
                        if (!response.ok) throw new Error('Failed to load leak report');
                        
                        const data = await response.json();
                        const leakReports = data.leak_reports || {};

                        if (Object.keys(leakReports).length === 0) {
                            container.innerHTML = '<div class="text-muted text-center py-8">No leak detection data available. Make sure you have multiple profile snapshots for comparison.</div>';
                            return;
                        }

                        let html = '';
                        for (const [type, report] of Object.entries(leakReports)) {
                            const typeName = type === 'heap' ? 'Memory Leak Analysis' : 'Goroutine Leak Analysis';
                            const icon = type === 'heap' ? 'üì¶' : 'üßµ';
                            
                            html += this.renderLeakReportSection(typeName, icon, report);
                        }

                        container.innerHTML = html;
                    } catch (err) {
                        console.error('Failed to load leak report:', err);
                        container.innerHTML = '<div class="text-danger text-center py-8">Failed to load leak detection data</div>';
                    }
                },

                // Render a single leak report section
                renderLeakReportSection(title, icon, report) {
                    const severityColors = {
                        'none': 'leak-section-none',
                        'low': 'leak-section-low',
                        'medium': 'leak-section-medium',
                        'high': 'leak-section-high',
                        'critical': 'leak-section-critical'
                    };
                    const severityBadgeColors = {
                        'none': 'leak-severity-none',
                        'low': 'leak-severity-low',
                        'medium': 'leak-severity-medium',
                        'high': 'leak-severity-high',
                        'critical': 'leak-severity-critical'
                    };
                    const severity = report.severity || 'none';
                    const colorClass = severityColors[severity] || severityColors['none'];
                    const badgeClass = severityBadgeColors[severity] || severityBadgeColors['none'];

                    let growthItemsHtml = '';
                    if (report.growth_items && report.growth_items.length > 0) {
                        growthItemsHtml = `
                            <div class="mt-4">
                                <h4 class="text-sm font-semibold text-secondary mb-2">Growth Items (${report.growth_items.length})</h4>
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    ${report.growth_items.map(item => `
                                        <div class="p-3 bg-muted rounded-lg">
                                            <div class="flex items-center justify-between">
                                                <span class="font-mono text-sm text-base truncate" title="${Utils.escapeHtml(item.name)}">${Utils.escapeHtml(item.name)}</span>
                                                <span class="text-sm font-semibold ${item.growth_percent > 50 ? 'text-danger' : 'text-warning'}">+${item.growth_percent?.toFixed(1) || 0}%</span>
                                            </div>
                                            <div class="flex items-center gap-4 mt-1 text-xs text-muted">
                                                <span>Baseline: ${Utils.formatBytes(item.baseline_value)}</span>
                                                <span>Current: ${Utils.formatBytes(item.current_value)}</span>
                                                <span>Growth: ${Utils.formatBytes(item.growth_value)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="leak-section ${colorClass} rounded-xl p-5">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${icon}</span>
                                    <h3 class="text-lg font-semibold text-base">${title}</h3>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${badgeClass}">${severity.toUpperCase()}</span>
                            </div>
                            <p class="text-secondary mb-4">${report.conclusion || 'No conclusion available'}</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="p-3 leak-stat-box rounded-lg">
                                    <div class="text-muted">Baseline</div>
                                    <div class="font-semibold text-base">${Utils.formatBytes(report.baseline_total)}</div>
                                </div>
                                <div class="p-3 leak-stat-box rounded-lg">
                                    <div class="text-muted">Current</div>
                                    <div class="font-semibold text-base">${Utils.formatBytes(report.current_total)}</div>
                                </div>
                                <div class="p-3 leak-stat-box rounded-lg">
                                    <div class="text-muted">Growth</div>
                                    <div class="font-semibold ${report.total_growth > 0 ? 'text-danger' : 'text-success'}">${report.total_growth > 0 ? '+' : ''}${Utils.formatBytes(report.total_growth)}</div>
                                </div>
                                <div class="p-3 leak-stat-box rounded-lg">
                                    <div class="text-muted">Growth %</div>
                                    <div class="font-semibold ${report.total_growth_percent > 0 ? 'text-danger' : 'text-success'}">${report.total_growth_percent?.toFixed(2) || 0}%</div>
                                </div>
                            </div>
                            ${growthItemsHtml}
                        </div>
                    `;
                },

                // Search in flame graph
                searchInFlameGraph(funcName) {
                    this.showPanel('flamegraph');
                    setTimeout(() => FlameGraph.searchFor(funcName), 100);
                },

                // Search in call graph
                searchInCallGraph(funcName) {
                    this.showPanel('callgraph');
                    setTimeout(() => CallGraph.searchFor(funcName), 100);
                },

                // Helper methods for new mode-based metadata
                getModeClass(modeName) {
                    const modeMap = {
                        'java-cpu': 'java', 'java-alloc': 'memory', 'java-heap': 'heap',
                        'cpu': 'generic', 'go-pprof': 'pprof', 'pprof-all': 'pprof',
                        // Legacy fallbacks
                        'java': 'java', 'generic': 'generic', 'pprof_mem': 'pprof',
                        'memleak': 'memory', 'java_heap': 'heap', 'pprof_all': 'pprof'
                    };
                    return modeMap[modeName] || 'generic';
                },

                getModeIcon(modeName) {
                    const iconMap = {
                        'java-cpu': '‚òïüî•', 'java-alloc': '‚òïüìà', 'java-heap': '‚òïüì¶',
                        'cpu': 'üî•', 'go-pprof': 'üêπ', 'pprof-all': 'üêπ',
                        // Legacy fallbacks
                        'java': '‚òï', 'generic': 'üîß', 'pprof_mem': 'üêπ', 'memleak': 'üíæ',
                        'java_heap': 'üì¶', 'pprof_all': 'üêπ'
                    };
                    return iconMap[modeName] || 'üìä';
                },

                getProfileIcon(profileName) {
                    const iconMap = {
                        'quick': '‚ö°', 'standard': '‚öñÔ∏è', 'detailed': 'üî¨',
                        // Legacy fallbacks
                        'perf': 'üî•', 'async_alloc': 'üìà', 'pprof': 'üêπ'
                    };
                    return iconMap[profileName] || 'üìä';
                },

                // Legacy helper methods (kept for backward compatibility)
                getTaskTypeClass(typeName) {
                    const typeMap = {
                        'java': 'java', 'generic': 'generic', 'pprof_mem': 'pprof',
                        'memleak': 'memory', 'java_heap': 'heap', 'phys_mem': 'memory',
                        'jeprof': 'memory', 'tracing': 'tracing', 'timing': 'tracing'
                    };
                    return typeMap[typeName] || 'generic';
                },

                getTaskTypeIcon(typeName) {
                    const iconMap = {
                        'java': '‚òï', 'generic': 'üîß', 'pprof_mem': 'üêπ', 'memleak': 'üíæ',
                        'java_heap': 'üì¶', 'phys_mem': 'üß†', 'jeprof': 'üìä', 'tracing': 'üîç',
                        'timing': '‚è±Ô∏è', 'bolt': '‚ö°'
                    };
                    return iconMap[typeName] || 'üìä';
                },

                getProfilerIcon(profilerName) {
                    const iconMap = { 'perf': 'üî•', 'async_alloc': 'üìà', 'pprof': 'üêπ' };
                    return iconMap[profilerName] || 'üìä';
                }
            };
        }

        // Register Alpine store for global access
        document.addEventListener('alpine:init', () => {
            Alpine.store('app', {
                getAppData() {
                    const appEl = document.querySelector('[x-data]');
                    return appEl && appEl._x_dataStack ? appEl._x_dataStack[0] : null;
                },
                searchInFlameGraph(funcName) {
                    const appData = this.getAppData();
                    if (appData) {
                        appData.searchInFlameGraph(funcName);
                    }
                },
                searchInCallGraph(funcName) {
                    const appData = this.getAppData();
                    if (appData) {
                        appData.searchInCallGraph(funcName);
                    }
                }
            });
        });
    </script>

    <!-- Application Scripts -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/flamegraph.js"></script>
    <script src="/static/js/callgraph.js"></script>
    <!-- CPU Analysis Scripts -->
    <script src="/static/js/threads.js"></script>
    <script src="/static/js/topfuncs.js"></script>
    <!-- Heap Analysis Modular Scripts (load order matters) -->
    <script src="/static/js/heap-core.js"></script>
    <script src="/static/js/heap-treemap.js"></script>
    <script src="/static/js/heap-biggest-objects.js"></script>
    <script src="/static/js/heap-histogram.js"></script>
    <script src="/static/js/heap-gcroots.js"></script>
    <script src="/static/js/heap-merged-paths.js"></script>
    <script src="/static/js/heap.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
